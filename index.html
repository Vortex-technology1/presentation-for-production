<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #2c3e50; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; }
        .lang-switch { display: flex; gap: 0.5rem; }
        .lang-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .lang-btn.active { background: rgba(255,255,255,0.3); font-weight: 600; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .controls { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .btn { background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; font-weight: 500; }
        .btn:hover { background: #2980b9; transform: translateY(-1px); }
        .btn-success { background: #27ae60; } .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; } .btn-danger:hover { background: #c0392b; }
        .btn-clear { background: #95a5a6; color: white; } .btn-clear:hover { background: #7f8c8d; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 3px; }
        .filters { display: flex; gap: 0.5rem; margin-left: auto; flex-wrap: wrap; }
        .filter-select { padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; background: white; font-size: 0.8rem; }
        .tab-navigation { display: flex; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 0; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .tab-navigation::-webkit-scrollbar { display: none; }
        .tab-btn { background: transparent; border: none; padding: 1rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #7f8c8d; transition: all 0.3s; border-bottom: 3px solid transparent; white-space: nowrap; min-width: fit-content; }
        .tab-btn:hover { color: #2c3e50; background: rgba(52, 73, 94, 0.05); }
        .tab-btn.active { color: #3498db; border-bottom-color: #3498db; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tasks-grid, .functions-grid, .control-dashboard, .analytics-container { background: white; border-radius: 0 0 10px 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .task-header { background: #34495e; color: white; padding: 1rem; display: grid; grid-template-columns: 3fr 1.2fr 1.2fr 1fr 0.8fr 0.8fr 1fr; gap: 0.5rem; font-weight: 600; font-size: 0.85rem; }
        .task-row { padding: 0.75rem; display: grid; grid-template-columns: 3fr 1.2fr 1.2fr 1fr 0.8fr 0.8fr 1fr; gap: 0.5rem; border-bottom: 1px solid #ecf0f1; align-items: center; transition: all 0.3s; font-size: 0.85rem; }
        .task-row:hover { background: #f8f9fa; }
        .task-row.pinned { background: linear-gradient(90deg, rgba(52, 152, 219, 0.1) 0%, rgba(255, 255, 255, 1) 100%); border-left: 4px solid #3498db; }
        .task-title { font-weight: 600; color: #2c3e50; font-size: 0.9rem; }
        .task-info { font-size: 0.75rem; color: #7f8c8d; margin-top: 0.25rem; }
        .task-title-container { display: flex; align-items: center; gap: 0.5rem; }
        .pin-btn { background: none; border: none; cursor: pointer; font-size: 1rem; color: #bdc3c7; transition: all 0.3s; padding: 0.2rem; }
        .pin-btn:hover { color: #f39c12; transform: scale(1.1); }
        .pin-btn.pinned { color: #f39c12; }
        .status-badge, .type-badge { padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 500; text-align: center; }
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-progress { background: #fff3e0; color: #f57c00; }
        .status-review { background: #fce4ec; color: #c2185b; }
        .status-done { background: #e8f5e8; color: #388e3c; }
        .type-single { background: #e3f2fd; color: #1976d2; }
        .type-regular { background: #f3e5f5; color: #7b1fa2; }
        .type-bottleneck { background: #ffebee; color: #d32f2f; }
        .empty-state { text-align: center; padding: 3rem 2rem; color: #7f8c8d; }
        .empty-state h3 { margin-bottom: 1rem; color: #34495e; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 2% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { background: #34495e; color: white; padding: 1.5rem; border-radius: 10px 10px 0 0; }
        .modal-body { padding: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: span 2; }
        .form-label { margin-bottom: 0.5rem; font-weight: 600; color: #34495e; font-size: 0.9rem; }
        .form-input, .form-select, .form-textarea { padding: 0.6rem; border: 2px solid #ecf0f1; border-radius: 5px; font-size: 0.9rem; transition: border-color 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3498db; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .close { color: #aaa; float: right; font-size: 24px; font-weight: bold; cursor: pointer; margin-top: -5px; }
        .close:hover { color: white; }
        .functions-grid { padding: 1.5rem; }
        .function-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .function-card { background: #f8f9fa; border: 2px solid #ecf0f1; border-radius: 10px; padding: 1.2rem; transition: all 0.3s; }
        .function-card:hover { border-color: #3498db; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .function-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .function-description { color: #7f8c8d; margin-bottom: 1rem; line-height: 1.4; font-size: 0.85rem; }
        .function-assignees { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem; }
        .assignee-badge { background: #27ae60; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; }
        .function-tasks-count { color: #3498db; font-weight: 600; font-size: 0.85rem; }
        .control-dashboard, .analytics-container { padding: 1.5rem; }
        .control-overview, .analytics-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .control-card, .analytics-card { border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .control-card.urgent { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; }
        .control-card.warning { background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%); color: white; }
        .control-card.active { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; }
        .control-card.completed { background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); color: white; }
        .analytics-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .control-number, .analytics-number { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; }
        .control-filters { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; background: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .chart-container { background: #f8f9fa; border-radius: 8px; padding: 1rem; min-height: 200px; margin-bottom: 1rem; }
        .chart-container h3 { color: #2c3e50; font-size: 1rem; margin-bottom: 0.8rem; }
        .regular-tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; padding: 1rem; }
        .regular-task-card { background: white; border: 2px solid #ecf0f1; border-radius: 12px; padding: 1.2rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .regular-task-card:hover { border-color: #3498db; transform: translateY(-1px); }
        .regular-task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; }
        .regular-task-title { font-size: 1rem; font-weight: 600; color: #2c3e50; flex: 1; }
        .regular-task-info { background: #f8f9fa; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem; font-size: 0.8rem; line-height: 1.4; }
        .regular-task-info div { margin-bottom: 0.3rem; }
        .regular-task-info strong { color: #34495e; font-weight: 600; }
        .regular-task-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
        #dateRangeInputs { display: none; align-items: center; gap: 0.3rem; }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .task-header, .task-row { grid-template-columns: 1fr; gap: 0.3rem; }
            .task-header > div, .task-row > div { padding: 0.3rem 0; border-bottom: 1px solid #ecf0f1; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            .filters { margin-left: 0; justify-content: flex-start; }
            .controls { flex-direction: column; align-items: stretch; }
            .tab-btn { padding: 0.8rem 1rem; }
        }

        /* üîê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø */
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: calc(100vh - 200px); padding: 2rem; }
        .auth-card { background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 0; max-width: 400px; width: 100%; overflow: hidden; }
        .auth-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; }
        .auth-header h2 { margin-bottom: 0.5rem; font-size: 1.8rem; }
        .auth-header p { opacity: 0.9; font-size: 0.9rem; }
        .auth-body { padding: 2rem; }
        .auth-form h3 { margin-bottom: 1.5rem; color: #2c3e50; text-align: center; }
        .main-interface { display: none; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä Pro</div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="https://alextalko.com" target="_blank" style="background: rgba(255,255,255,0.15); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; color: white; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    –ü—ñ–¥—Ç—Ä–∏–º–∫–∞
                </a>
                <div id="currentCompanyInfo" style="background: rgba(255,255,255,0.15); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; display: none;">
                    üè¢ <span id="currentCompanyName"></span>
                </div>
                <div id="currentUserInfo" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer;" onclick="switchUserForTesting()">
                    üë§ <span id="currentUserName">–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ</span> 
                    <span id="currentUserRole" style="font-size: 0.8rem; opacity: 0.8;">(–í–ª–∞—Å–Ω–∏–∫)</span>
                    <span style="font-size: 0.7rem; opacity: 0.7;">‚Üª</span>
                </div>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem; margin-left: 0.5rem;">
                    üö™ –í–∏–π—Ç–∏
                </button>
                <div class="lang-switch">
                    <button class="lang-btn active" onclick="setLanguage('ua')">UA</button>
                    <button class="lang-btn" onclick="setLanguage('ru')">RU</button>
                    <button class="lang-btn" onclick="setLanguage('bg')">BG</button>
                    <button class="lang-btn" onclick="setLanguage('en')">EN</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- üîê –°–¢–û–†–Ü–ù–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á -->
        <div id="authPage" class="auth-container" style="display: none;">
            <div class="auth-card">
                <div class="auth-header">
                    <h2>üöÄ TALKO System</h2>
                    <p>–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏ –¥–ª—è –±—ñ–∑–Ω–µ—Å—É</p>
                </div>
                <div class="auth-body">
                    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É -->
                    <div id="loginForm" class="auth-form">
                        <h3>–í—Ö—ñ–¥ –¥–æ —Å–∏—Å—Ç–µ–º–∏</h3>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com" required>
                        </div>
                        <button onclick="sendLoginCode()" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                            üìß –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥
                        </button>
                        <div style="text-align: center; margin-top: 1rem;">
                            <small style="color: #7f8c8d;">–ú–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–º–æ –∫–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞ –≤–∞—à email</small>
                        </div>
                        <div style="text-align: center; margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <p style="color: #7f8c8d; font-size: 0.9rem; margin: 0;">
                                <strong>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É?</strong><br>
                                –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–∏ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–∫–∞—É–Ω—Ç—É
                            </p>
                        </div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É -->
                    <div id="codeForm" class="auth-form" style="display: none;">
                        <h3>–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
                        <div class="form-group">
                            <label>–ö–æ–¥ –∑ email:</label>
                            <input type="text" id="loginCode" class="form-input" placeholder="123456" maxlength="6" required>
                        </div>
                        <button onclick="verifyLoginCode()" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                            ‚úÖ –£–≤—ñ–π—Ç–∏
                        </button>
                        <button onclick="backToLogin()" class="btn" style="width: 100%; margin-top: 0.5rem;">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                    </div>
                    
                    <!-- –í–∏–±—ñ—Ä –∫–æ–º–ø–∞–Ω—ñ—ó -->
                    <div id="companySelectForm" class="auth-form" style="display: none;">
                        <h3>–û–±–µ—Ä—ñ—Ç—å –∫–æ–º–ø–∞–Ω—ñ—é</h3>
                        <div id="companiesList"></div>
                        <button onclick="logout()" class="btn" style="width: 100%; margin-top: 1rem;">
                            üö™ –í–∏–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- üì± –û–°–ù–û–í–ù–ò–ô –Ü–ù–¢–ï–†–§–ï–ô–° -->
        <div id="mainInterface" class="main-interface">
            <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('tasks')">–ó–∞–≤–¥–∞–Ω–Ω—è</button>
            <button class="tab-btn" onclick="switchTab('control')">–ö–æ–Ω—Ç—Ä–æ–ª—å</button>
            <button class="tab-btn" onclick="switchTab('regular')">–†–µ–≥—É–ª—è—Ä–Ω—ñ</button>
            <button class="tab-btn" onclick="switchTab('functions')">–§—É–Ω–∫—Ü—ñ—ó</button>
            <button class="tab-btn" onclick="switchTab('users')">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</button>
            <button class="tab-btn" onclick="switchTab('analytics')">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–≤–¥–∞–Ω–Ω—è -->
        <div id="tasksTab" class="tab-content active">
            <div class="controls">
                <button class="btn btn-success" onclick="openTaskModal()">+ –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
                <button class="btn" onclick="exportToCSV()">üìä –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
                <div class="filters">
                    <button class="btn btn-clear" onclick="clearFilters()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
                    <select class="filter-select" id="pinnedFilter" onchange="applyFilters()">
                        <option value="">–í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</option>
                        <option value="pinned">–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω—ñ</option>
                        <option value="unpinned">–ù–µ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω—ñ</option>
                    </select>
                    <select class="filter-select" id="dateFilter" onchange="applyFilters()">
                        <option value="">–í—Å—ñ –¥–∞—Ç–∏</option>
                        <option value="today">–°—å–æ–≥–æ–¥–Ω—ñ</option>
                        <option value="week">–¢–∏–∂–¥–µ–Ω—å</option>
                        <option value="month">–ú—ñ—Å—è—Ü—å</option>
                        <option value="overdue">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ</option>
                        <option value="custom">–ü–µ—Ä—ñ–æ–¥</option>
                    </select>
                    <div id="dateRangeInputs">
                        <input type="date" id="dateFrom" class="filter-select" onchange="applyFilters()">
                        <span>‚Äî</span>
                        <input type="date" id="dateTo" class="filter-select" onchange="applyFilters()">
                    </div>
                    <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">–°—Ç–∞—Ç—É—Å–∏</option>
                        <option value="new">–ù–æ–≤—ñ</option>
                        <option value="progress">–í —Ä–æ–±–æ—Ç—ñ</option>
                        <option value="review">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</option>
                        <option value="done">–ì–æ—Ç–æ–≤–æ</option>
                    </select>
                    <select class="filter-select" id="functionFilter" onchange="applyFilters()">
                        <option value="">–§—É–Ω–∫—Ü—ñ—ó</option>
                    </select>
                    <select class="filter-select" id="assigneeFilter" onchange="applyFilters()">
                        <option value="">–í–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>
                    </select>
                </div>
            </div>
            <div class="tasks-grid" id="tasksContainer"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ö–æ–Ω—Ç—Ä–æ–ª—å -->
        <div id="controlTab" class="tab-content">
            <div class="control-dashboard">
                <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">–ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç—Ä–æ–ª—é –∑–∞–≤–¥–∞–Ω—å</h2>
                
                <!-- üîç –§–Ü–õ–¨–¢–†–ò –ö–û–ù–¢–†–û–õ–Æ -->
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <div>
                            <label style="font-size: 0.9rem; color: #7f8c8d;">üë§ –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:</label>
                            <select id="controlAssigneeFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="updateControlPanel()">
                                <option value="">–í—Å—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: #7f8c8d;">üè∑Ô∏è –§—É–Ω–∫—Ü—ñ—è:</label>
                            <select id="controlFunctionFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="updateControlPanel()">
                                <option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: #7f8c8d;">üìÖ –ü–µ—Ä—ñ–æ–¥:</label>
                            <select id="controlPeriodFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="updateControlPanel()">
                                <option value="all">–í–µ—Å—å —á–∞—Å</option>
                                <option value="week">–¢–∏–∂–¥–µ–Ω—å</option>
                                <option value="month">–ú—ñ—Å—è—Ü—å</option>
                            </select>
                        </div>
                        <button onclick="clearControlFilters()" style="background: #95a5a6; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 5px; cursor: pointer;">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏
                        </button>
                    </div>
                </div>

                <div class="control-overview">
                    <div class="control-card urgent">
                        <h3>üö® –ö—Ä–∏—Ç–∏—á–Ω—ñ</h3>
                        <div class="control-number" id="urgentCount">0</div>
                        <p>–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ</p>
                    </div>
                    <div class="control-card warning">
                        <h3>‚ö†Ô∏è –£–≤–∞–≥–∞</h3>
                        <div class="control-number" id="warningCount">0</div>
                        <p>–°—å–æ–≥–æ–¥–Ω—ñ-–∑–∞–≤—Ç—Ä–∞</p>
                    </div>
                    <div class="control-card active">
                        <h3>üîÑ –ê–∫—Ç–∏–≤–Ω—ñ</h3>
                        <div class="control-number" id="activeCount">0</div>
                        <p>–í —Ä–æ–±–æ—Ç—ñ</p>
                    </div>
                    <div class="control-card completed">
                        <h3>‚úÖ –ì–æ—Ç–æ–≤–æ</h3>
                        <div class="control-number" id="completedCount">0</div>
                        <p>–ó–∞–≤–µ—Ä—à–µ–Ω—ñ</p>
                    </div>
                </div>
                <div class="control-filters">
                    <label style="font-weight: 600; color: #2c3e50;">–ü–µ—Ä–µ–≥–ª—è–¥:</label>
                    <select id="controlView" onchange="updateControlView()" class="filter-select">
                        <option value="workload">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</option>
                        <option value="deadlines">–î–µ–¥–ª–∞–π–Ω–∏</option>
                        <option value="functions">–§—É–Ω–∫—Ü—ñ—ó</option>
                    </select>
                </div>
                <div id="controlContent"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –†–µ–≥—É–ª—è—Ä–Ω—ñ -->
        <div id="regularTab" class="tab-content">
            
            <!-- üîç –î–ò–ù–ê–ú–Ü–ß–ù–Ü –§–Ü–õ–¨–¢–†–ò –î–õ–Ø –†–ï–ì–£–õ–Ø–†–ù–ò–• –ó–ê–í–î–ê–ù–¨ -->
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div>
                        <label style="font-size: 0.9rem; color: #7f8c8d;">üë§ –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:</label>
                        <select id="regularAssigneeFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="filterRegularTasks()">
                            <option value="">–í—Å—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #7f8c8d;">üè∑Ô∏è –§—É–Ω–∫—Ü—ñ—è:</label>
                        <select id="regularFunctionFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="filterRegularTasks()">
                            <option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                        </select>
                    </div>
                    <button onclick="clearRegularFilters()" style="background: #95a5a6; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 5px; cursor: pointer;">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏
                    </button>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-success" onclick="openRegularTaskModal()">+ –†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
            </div>
            <div id="regularTasksContainer"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –§—É–Ω–∫—Ü—ñ—ó -->
        <div id="functionsTab" class="tab-content">
            <div class="controls">
                <button class="btn btn-success" onclick="openFunctionModal()">+ –î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é</button>
            </div>
            <div id="functionsContainer" class="functions-grid"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏ -->
        <div id="usersTab" class="tab-content">
            
            <!-- üîç –ü–û–®–£–ö –°–ü–Ü–í–†–û–ë–Ü–¢–ù–ò–ö–Ü–í -->
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div>
                        <label style="font-size: 0.9rem; color: #7f8c8d;">üîç –ü–æ—à—É–∫:</label>
                        <input type="text" id="userSearchInput" placeholder="–Ü–º'—è –∞–±–æ email" style="margin-left: 0.5rem; padding: 0.3rem;" onkeyup="filterUsers()">
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #7f8c8d;">üë®‚Äçüíº –†–æ–ª—å:</label>
                        <select id="userRoleFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="filterUsers()">
                            <option value="">–í—Å—ñ —Ä–æ–ª—ñ</option>
                            <option value="owner">–í–ª–∞—Å–Ω–∏–∫</option>
                            <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                            <option value="employee">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #7f8c8d;">üè¢ –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label>
                        <select id="userDepartmentFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="filterUsers()">
                            <option value="">–í—Å—ñ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #7f8c8d;">üè∑Ô∏è –§—É–Ω–∫—Ü—ñ—è:</label>
                        <select id="userFunctionFilter" style="margin-left: 0.5rem; padding: 0.3rem;" onchange="filterUsers()">
                            <option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                        </select>
                    </div>
                    <button onclick="clearUserFilters()" style="background: #95a5a6; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 5px; cursor: pointer;">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏
                    </button>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
                <div id="userStats" style="margin-top: 1rem; padding: 0.8rem; background: white; border-radius: 5px; font-size: 0.85rem; color: #7f8c8d;"></div>
            </div>

            <div class="controls">
                <button class="btn btn-success" onclick="openUserModal()">+ –î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</button>
                <button class="btn" onclick="openInviteModal()" style="background: #f39c12;">üì§ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</button>
                <button class="btn" onclick="alert('–ï–∫—Å–ø–æ—Ä—Ç CSV –≥–æ—Ç—É—î—Ç—å—Å—è...')" style="background: #27ae60;">üìä –ï–∫—Å–ø–æ—Ä—Ç</button>
            </div>
            <div id="usersContainer" class="functions-grid"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ -->
        <div id="analyticsTab" class="tab-content">
            <div class="analytics-container">
                <div class="analytics-cards">
                    <div class="analytics-card">
                        <h3>–í—Å—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω—å</h3>
                        <div class="analytics-number" id="totalTasksCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>–í–∏–∫–æ–Ω–∞–Ω–æ</h3>
                        <div class="analytics-number" id="completedTasksCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ</h3>
                        <div class="analytics-number" id="overdueTasksCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</h3>
                        <div class="analytics-number" id="efficiencyPercent">0%</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="chart-container">
                        <h3>–°—Ç–∞—Ç—É—Å–∏ –∑–∞–≤–¥–∞–Ω—å</h3>
                        <div id="statusChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3>–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
                        <div id="workloadChart"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeTaskModal()">&times;</span>
                <h2 id="modalTitle">–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è:</label>
                            <input type="text" id="taskTitle" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§—É–Ω–∫—Ü—ñ—è:</label>
                            <select id="taskFunction" class="form-select">
                                <option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π:</label>
                            <select id="taskAssignee" class="form-select" required>
                                <option value="">–û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–≤—Ü—è</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–µ–¥–ª–∞–π–Ω:</label>
                            <input type="datetime-local" id="taskDeadline" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‚è±Ô∏è –ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</label>
                            <select id="taskDuration" class="form-select" required>
                                <option value="">–û–±–µ—Ä—ñ—Ç—å —á–∞—Å</option>
                                <option value="15min">15 —Ö–≤–∏–ª–∏–Ω</option>
                                <option value="30min">30 —Ö–≤–∏–ª–∏–Ω</option>
                                <option value="1hour">1 –≥–æ–¥–∏–Ω–∞</option>
                                <option value="2hours">2 –≥–æ–¥–∏–Ω–∏</option>
                                <option value="4hours">4 –≥–æ–¥–∏–Ω–∏</option>
                                <option value="1day">1 –¥–µ–Ω—å</option>
                                <option value="2days">2 –¥–Ω—ñ</option>
                                <option value="1week">1 —Ç–∏–∂–¥–µ–Ω—å</option>
                                <option value="2weeks">2 —Ç–∏–∂–Ω—ñ</option>
                                <option value="1month">1 –º—ñ—Å—è—Ü—å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–∏–ø:</label>
                            <select id="taskType" class="form-select">
                                <option value="single">–†–∞–∑–æ–≤–µ</option>
                                <option value="regular">–†–µ–≥—É–ª—è—Ä–Ω–µ</option>
                                <option value="bottleneck">–í—É–∑—å–∫–µ –º—ñ—Å—Ü–µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å:</label>
                            <select id="taskStatus" class="form-select">
                                <option value="new">–ù–æ–≤–µ</option>
                                <option value="progress">–í —Ä–æ–±–æ—Ç—ñ</option>
                                <option value="review">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</option>
                                <option value="done">–ì–æ—Ç–æ–≤–æ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏:</label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="checkbox" id="taskPinned">
                                <span>–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:</label>
                            <select id="taskPriority" class="form-select">
                                <option value="low">–ù–∏–∑—å–∫–∏–π</option>
                                <option value="medium">–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                                <option value="high">–í–∏—Å–æ–∫–∏–π</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</label>
                            <textarea id="taskInfo" class="form-textarea" placeholder="–î–µ—Ç–∞–ª—ñ –∑–∞–≤–¥–∞–Ω–Ω—è, –∫–æ–Ω—Ç–µ–∫—Å—Ç, –≤–∏–º–æ–≥–∏..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–Ø–∫ –∑–≤—ñ—Ç—É–≤–∞—Ç–∏—Å—è:</label>
                            <textarea id="taskReporting" class="form-textarea" placeholder="–ö—É–¥–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç, —É —è–∫–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–¥–∞–Ω–Ω—è:</label>
                            <textarea id="taskResult" class="form-textarea" placeholder="–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏, –≤–∏—Å–Ω–æ–≤–∫–∏..."></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeTaskModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="functionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeFunctionModal()">&times;</span>
                <h2>–î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é</h2>
            </div>
            <div class="modal-body">
                <form id="functionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞:</label>
                            <input type="text" id="functionName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üè¢ –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label>
                            <input type="text" id="functionDepartment" class="form-input" placeholder="IT, –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, –ü—Ä–æ–¥–∞–∂—ñ...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ö–æ–ª—ñ—Ä:</label>
                            <input type="color" id="functionColor" class="form-input" value="#3498db">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–û–ø–∏—Å:</label>
                            <textarea id="functionDescription" class="form-textarea"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:</label>
                            <div id="functionAssignees"></div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeFunctionModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="regularTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeRegularTaskModal()">&times;</span>
                <h2>–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
            </div>
            <div class="modal-body">
                <form id="regularTaskForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">–ù–∞–∑–≤–∞:</label>
                            <input type="text" id="regularTaskTitle" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§—É–Ω–∫—Ü—ñ—è:</label>
                            <select id="regularTaskFunction" class="form-select">
                                <option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π:</label>
                            <select id="regularTaskAssignee" class="form-select" required>
                                <option value="">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ—Å—Ç—å:</label>
                            <select id="regularTaskPeriod" class="form-select" onchange="updatePeriodOptions()">
                                <option value="daily">–©–æ–¥–Ω—è</option>
                                <option value="weekly">–©–æ—Ç–∏–∂–Ω—è</option>
                                <option value="monthly">–©–æ–º—ñ—Å—è—Ü—è</option>
                                <option value="workdays">–†–æ–±–æ—á—ñ –¥–Ω—ñ</option>
                                <option value="weekends">–í–∏—Ö—ñ–¥–Ω—ñ</option>
                                <option value="custom">–í–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ</option>
                            </select>
                        </div>
                        <div class="form-group" id="customDaysContainer" style="display: none;">
                            <label class="form-label">–î–Ω—ñ —Ç–∏–∂–Ω—è:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="1"> –ü–æ–Ω–µ–¥—ñ–ª–æ–∫
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="2"> –í—ñ–≤—Ç–æ—Ä–æ–∫
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="3"> –°–µ—Ä–µ–¥–∞
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="4"> –ß–µ—Ç–≤–µ—Ä
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="5"> –ü'—è—Ç–Ω–∏—Ü—è
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="6"> –°—É–±–æ—Ç–∞
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="0"> –ù–µ–¥—ñ–ª—è
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–Ω—ñ–≤ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</label>
                            <input type="number" id="regularTaskDuration" class="form-input" value="1" min="1" max="30">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–û–ø–∏—Å:</label>
                            <textarea id="regularTaskDescription" class="form-textarea"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeRegularTaskModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeUserModal()">&times;</span>
                <h2 id="userModalTitle">–î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</h2>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ:</label>
                            <input type="text" id="userName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email:</label>
                            <input type="email" id="userEmail" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                            <input type="tel" id="userPhone" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–†–æ–ª—å:</label>
                            <select id="userRole" class="form-select" required>
                                <option value="employee">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</option>
                                <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                                <option value="owner">–í–ª–∞—Å–Ω–∏–∫</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–æ—Å–∞–¥–∞:</label>
                            <input type="text" id="userPosition" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label>
                            <input type="text" id="userDepartment" class="form-input">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</label>
                            <textarea id="userNotes" class="form-textarea" placeholder="–î–æ—Å–≤—ñ–¥, –Ω–∞–≤–∏—á–∫–∏, –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ..."></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeUserModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeInviteModal()">&times;</span>
                <h2>üì§ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</h2>
            </div>
            <div class="modal-body">
                <form id="inviteFormModal">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Email —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞:</label>
                            <input type="email" id="inviteEmail" class="form-input" required placeholder="colleague@email.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–†–æ–ª—å:</label>
                            <select id="inviteRole" class="form-select" required>
                                <option value="employee">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</option>
                                <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§—É–Ω–∫—Ü—ñ—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):</label>
                            <select id="inviteFunction" class="form-select">
                                <option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–æ—Å–∞–¥–∞:</label>
                            <input type="text" id="invitePosition" class="form-input" placeholder="–†–æ–∑—Ä–æ–±–Ω–∏–∫, –î–∏–∑–∞–π–Ω–µ—Ä...">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):</label>
                            <textarea id="inviteMessage" class="form-textarea" placeholder="–í—ñ—Ç–∞—î–º–æ –≤ –∫–æ–º–∞–Ω–¥—ñ TALKO System!"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeInviteModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">üì§ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="inviteLinkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeInviteLinkModal()">&times;</span>
                <h2>‚úÖ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ!</h2>
            </div>
            <div class="modal-body">
                <div style="text-align: center;">
                    <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                        <p style="margin-bottom: 1rem; color: #27ae60; font-weight: 600;">üìß –°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤—Ç–µ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—É:</p>
                        <div style="background: white; padding: 1rem; border-radius: 5px; border: 2px dashed #27ae60; word-break: break-all; font-family: monospace; font-size: 0.9rem;" id="inviteLinkText"></div>
                    </div>
                    
                    <button onclick="copyInviteLink()" class="btn btn-success" style="margin-right: 0.5rem;">
                        üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                    </button>
                    <button onclick="shareInviteEmail()" class="btn" style="background: #3498db;">
                        üìß –í—ñ–¥–∫—Ä–∏—Ç–∏ Email
                    </button>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 5px; font-size: 0.85rem; color: #7f8c8d;">
                        üí° <strong>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥—ñ—î 7 –¥–Ω—ñ–≤</strong><br>
                        –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ –∑–º–æ–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è —Ç–∞ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Å–∏—Å—Ç–µ–º–∏
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• FIREBASE CONFIGURATION
        // üî• FIREBASE –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø - –¢–í–Ü–ô PRODUCTION –ü–†–û–ï–ö–¢
        const firebaseConfig = {
            apiKey: "AIzaSyCIHYGKw2pZXBXrR7lYFXOB1_F616rufGc",
            authDomain: "talko-task-system-prod.firebaseapp.com",
            projectId: "talko-task-system-prod", 
            storageBucket: "talko-task-system-prod.firebasestorage.app",
            messagingSenderId: "840530352572",
            appId: "1:840530352572:web:27200f053aa2c9671773b9"
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
        let db = null, auth = null;
        let isFirebaseEnabled = true; // üî• –°–ü–†–ê–í–ñ–ù–Ü–ô FIREBASE –£–í–Ü–ú–ö–ù–ï–ù–û!

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            isFirebaseEnabled = true;
            console.log('üî• Firebase —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
        } catch (error) {
            console.log('üì± Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –ø—Ä–∞—Ü—é—î–º–æ –≤ demo —Ä–µ–∂–∏–º—ñ');
            isFirebaseEnabled = false;
        }

        // üè¢ –ú–£–õ–¨–¢–ò–¢–ï–ù–ê–ù–¢–ù–Ü–°–¢–¨ - –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ò–•
        let currentCompany = null; // –ü–æ—Ç–æ—á–Ω–∞ –∫–æ–º–ø–∞–Ω—ñ—è
        let companies = []; // –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–æ–º–ø–∞–Ω—ñ–π

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö –¥–ª—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—ñ
        const dataStructure = {
            companies: {
                // companyId: {
                //     id: "comp_123",
                //     name: "–¢–ê–õ–ö–û –ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥",
                //     owner: "alex@talko.com", 
                //     plan: "free",
                //     maxUsers: 10,
                //     createdAt: "2024-11-12",
                //     settings: { language: "ua", timezone: "Europe/Kiev" }
                // }
            },
            users: {
                // userId: {
                //     id: "user_456",
                //     companyId: "comp_123",
                //     name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ",
                //     email: "alex@talko.com", 
                //     role: "owner",
                //     createdAt: "2024-11-12"
                // }
            },
            tasks: {
                // taskId: {
                //     id: "task_789",
                //     companyId: "comp_123", 
                //     title: "–ê–Ω–∞–ª—ñ–∑ —Ä–∏–Ω–∫—É",
                //     assigneeId: "user_456",
                //     creatorId: "user_456",
                //     deadline: "2024-11-20T18:00:00Z",
                //     status: "new",
                //     createdAt: "2024-11-12"
                // }
            },
            functions: {
                // functionId: {
                //     id: "func_101",
                //     companyId: "comp_123",
                //     name: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", 
                //     description: "–†–µ–∫–ª–∞–º–∞ —ñ –ø—Ä–æ–º–æ",
                //     color: "#e74c3c",
                //     assigneeIds: ["user_456"]
                // }
            }
        };

        // üîê FIREBASE AUTH WRAPPER
        class AuthService {
            static async signInWithEmail(email) {
                if (!isFirebaseEnabled) {
                    return this.demoSignIn(email);
                }
                
                try {
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º—É Firebase –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ –± sendSignInLinkToEmail
                    const result = await auth.signInWithEmailAndPassword(email, 'demo-password');
                    return { success: true, user: result.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            static demoSignIn(email) {
                // Demo —Ä–µ–∂–∏–º - —Å–∏–º—É–ª—é—î–º–æ —É—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
                const demoUser = {
                    uid: 'demo-' + Math.random().toString(36).substr(2, 9),
                    email: email,
                    emailVerified: true
                };
                return { success: true, user: demoUser };
            }

            static async signOut() {
                if (isFirebaseEnabled) {
                    await auth.signOut();
                }
                currentCompany = null;
                currentUser = null;
                localStorage.removeItem('demo_session');
                showAuthPage();
            }

            static getCurrentUser() {
                if (isFirebaseEnabled && auth.currentUser) {
                    return auth.currentUser;
                }
                // Demo —Ä–µ–∂–∏–º
                const session = localStorage.getItem('demo_session');
                return session ? JSON.parse(session) : null;
            }
        }

        // üíæ FIREBASE DATABASE WRAPPER  
        class DatabaseService {
            static async createCompany(companyData) {
                const companyId = 'comp_' + Math.random().toString(36).substr(2, 9);
                const company = {
                    id: companyId,
                    ...companyData,
                    createdAt: new Date().toISOString()
                };

                if (isFirebaseEnabled) {
                    await db.collection('companies').doc(companyId).set(company);
                } else {
                    // Demo —Ä–µ–∂–∏–º - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω–æ
                    let demoCompanies = JSON.parse(localStorage.getItem('demo_companies') || '{}');
                    demoCompanies[companyId] = company;
                    localStorage.setItem('demo_companies', JSON.stringify(demoCompanies));
                }

                return company;
            }

            static async getCompaniesForUser(userEmail) {
                if (isFirebaseEnabled) {
                    const snapshot = await db.collection('companies')
                        .where('owner', '==', userEmail)
                        .get();
                    return snapshot.docs.map(doc => doc.data());
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    const demoCompanies = JSON.parse(localStorage.getItem('demo_companies') || '{}');
                    return Object.values(demoCompanies).filter(comp => comp.owner === userEmail);
                }
            }

            static async getUsersByCompany(companyId) {
                if (isFirebaseEnabled) {
                    const snapshot = await db.collection('users')
                        .where('companyId', '==', companyId)
                        .get();
                    return snapshot.docs.map(doc => doc.data());
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    const demoUsers = JSON.parse(localStorage.getItem('demo_users') || '{}');
                    return Object.values(demoUsers).filter(user => user.companyId === companyId);
                }
            }

            static async getTasksByCompany(companyId) {
                if (isFirebaseEnabled) {
                    const snapshot = await db.collection('tasks')
                        .where('companyId', '==', companyId)
                        .get();
                    return snapshot.docs.map(doc => doc.data());
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    const demoTasks = JSON.parse(localStorage.getItem('demo_tasks') || '{}');
                    return Object.values(demoTasks).filter(task => task.companyId === companyId);
                }
            }

            static async addTask(taskData) {
                const taskId = 'task_' + Math.random().toString(36).substr(2, 9);
                const task = {
                    id: taskId,
                    companyId: currentCompany.id,
                    ...taskData,
                    createdAt: new Date().toISOString()
                };

                if (isFirebaseEnabled) {
                    await db.collection('tasks').doc(taskId).set(task);
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    let demoTasks = JSON.parse(localStorage.getItem('demo_tasks') || '{}');
                    demoTasks[taskId] = task;
                    localStorage.setItem('demo_tasks', JSON.stringify(demoTasks));
                }

                return task;
            }

            static async updateTask(taskId, taskData) {
                if (isFirebaseEnabled) {
                    await db.collection('tasks').doc(taskId).update(taskData);
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    let demoTasks = JSON.parse(localStorage.getItem('demo_tasks') || '{}');
                    if (demoTasks[taskId]) {
                        demoTasks[taskId] = { ...demoTasks[taskId], ...taskData };
                        localStorage.setItem('demo_tasks', JSON.stringify(demoTasks));
                    }
                }
            }

            static async addFunction(functionData) {
                const functionId = 'func_' + Math.random().toString(36).substr(2, 9);
                const func = {
                    id: functionId,
                    companyId: currentCompany.id,
                    ...functionData,
                    createdAt: new Date().toISOString()
                };

                if (isFirebaseEnabled) {
                    await db.collection('functions').doc(functionId).set(func);
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    let demoFunctions = JSON.parse(localStorage.getItem('demo_functions') || '{}');
                    demoFunctions[functionId] = func;
                    localStorage.setItem('demo_functions', JSON.stringify(demoFunctions));
                }

                return func;
            }

            static async getFunctionsByCompany(companyId) {
                if (isFirebaseEnabled) {
                    const snapshot = await db.collection('functions')
                        .where('companyId', '==', companyId)
                        .get();
                    return snapshot.docs.map(doc => doc.data());
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    const demoFunctions = JSON.parse(localStorage.getItem('demo_functions') || '{}');
                    return Object.values(demoFunctions).filter(func => func.companyId === companyId);
                }
            }

            static async createUser(userData) {
                const userId = 'user_' + Math.random().toString(36).substr(2, 9);
                const user = {
                    id: userId,
                    ...userData,
                    createdAt: new Date().toISOString()
                };

                if (isFirebaseEnabled) {
                    await db.collection('users').doc(userId).set(user);
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    let demoUsers = JSON.parse(localStorage.getItem('demo_users') || '{}');
                    demoUsers[userId] = user;
                    localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                }

                return user;
            }

            static async updateUser(userId, userData) {
                if (isFirebaseEnabled) {
                    await db.collection('users').doc(userId).update(userData);
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    let demoUsers = JSON.parse(localStorage.getItem('demo_users') || '{}');
                    if (demoUsers[userId]) {
                        demoUsers[userId] = { ...demoUsers[userId], ...userData };
                        localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                    }
                }
            }

            static async deleteUser(userId) {
                if (isFirebaseEnabled) {
                    await db.collection('users').doc(userId).delete();
                } else {
                    // Demo —Ä–µ–∂–∏–º
                    let demoUsers = JSON.parse(localStorage.getItem('demo_users') || '{}');
                    delete demoUsers[userId];
                    localStorage.setItem('demo_users', JSON.stringify(demoUsers));
                }
            }
        }
        let tasks = [], users = [
            {id: 1, name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", role: "owner", email: "management.talco@gmail.com", phone: "+380501234567", position: "CEO", department: "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è", notes: "–ó–∞—Å–Ω–æ–≤–Ω–∏–∫ TALKO System"},
            {id: 2, name: "–ú–∞—Ä—ñ—è –ü–µ—Ç—Ä–µ–Ω–∫–æ", role: "manager", email: "maria@talko.com", phone: "+380501234568", position: "–ú–µ–Ω–µ–¥–∂–µ—Ä –∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É", department: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", notes: "5 —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É –≤ digital-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É"},
            {id: 3, name: "–Ü–≤–∞–Ω –ö–æ–≤–∞–ª–µ–Ω–∫–æ", role: "employee", email: "ivan@talko.com", phone: "+380501234569", position: "–†–æ–∑—Ä–æ–±–Ω–∏–∫", department: "IT", notes: "Frontend/Backend —Ä–æ–∑—Ä–æ–±–∫–∞"},
            {id: 4, name: "–û–ª—å–≥–∞ –°–∏–¥–æ—Ä–µ–Ω–∫–æ", role: "employee", email: "olga@talko.com", phone: "+380501234570", position: "–î–∏–∑–∞–π–Ω–µ—Ä", department: "–î–∏–∑–∞–π–Ω", notes: "UI/UX –¥–∏–∑–∞–π–Ω, –±—Ä–µ–Ω–¥–∏–Ω–≥"}
        ], functions = [], regularTasks = [], currentUser = {name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", role: "owner"};
        
        // –†–æ–±–ª—é activeTab –≥–ª–æ–±–∞–ª—å–Ω–æ—é
        let activeTab = 'tasks', editingTaskId = null, editingUserId = null;

        // üè¢ –§–£–ù–ö–¶–Ü–á –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –ö–û–ú–ü–ê–ù–Ü–Ø–ú–ò
        
        async function showCreateCompanyForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('companySelectForm').style.display = 'none';
            document.getElementById('createCompanyForm').style.display = 'block';
            clearCompanyForm();
        }

        function clearCompanyForm() {
            document.getElementById('companyName').value = '';
            document.getElementById('ownerName').value = '';
            document.getElementById('ownerEmail').value = '';
            document.getElementById('ownerPhone').value = '';
        }

        async function createCompany() {
            const companyName = document.getElementById('companyName').value.trim();
            const ownerName = document.getElementById('ownerName').value.trim();
            const ownerEmail = document.getElementById('ownerEmail').value.trim();
            const ownerPhone = document.getElementById('ownerPhone').value.trim();

            if (!companyName || !ownerName || !ownerEmail) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: –Ω–∞–∑–≤—É –∫–æ–º–ø–∞–Ω—ñ—ó, —ñ–º\'—è —Ç–∞ email');
                return;
            }

            try {
                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–ø–∞–Ω—ñ—ó
                const company = await DatabaseService.createCompany({
                    name: companyName,
                    owner: ownerEmail,
                    plan: 'free',
                    maxUsers: 10,
                    settings: {
                        language: currentLanguage,
                        timezone: 'Europe/Kiev'
                    }
                });

                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–∏–∫–∞ –∫–æ–º–ø–∞–Ω—ñ—ó
                await DatabaseService.createUser({
                    companyId: company.id,
                    name: ownerName,
                    email: ownerEmail,
                    phone: ownerPhone,
                    role: 'owner',
                    position: 'CEO',
                    department: 'Management'
                });

                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–µ–º–æ-–¥–∞–Ω–∏—Ö –¥–ª—è –Ω–æ–≤–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó
                await createDemoDataForCompany(company.id);

                alert(`üéâ –ö–æ–º–ø–∞–Ω—ñ—è "${companyName}" —Å—Ç–≤–æ—Ä–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!`);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤—Ö—ñ–¥
                currentCompany = company;
                currentUser = {
                    id: 'user_' + Math.random().toString(36).substr(2, 9),
                    companyId: company.id,
                    name: ownerName,
                    email: ownerEmail,
                    role: 'owner'
                };

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–µ—Å—ñ—é
                localStorage.setItem('demo_session', JSON.stringify({
                    user: currentUser,
                    company: company,
                    loginTime: Date.now()
                }));

                showMainInterface();
                updateCompanyInfo();
                await loadCompanyData();
                renderTasks();

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–ø–∞–Ω—ñ—ó:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–ø–∞–Ω—ñ—ó: ' + error.message);
            }
        }

        async function createDemoDataForCompany(companyId) {
            console.log('–°—Ç–≤–æ—Ä—é—î–º–æ –¥–µ–º–æ –¥–∞–Ω—ñ –¥–ª—è –∫–æ–º–ø–∞–Ω—ñ—ó:', companyId);
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –¥–µ–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó
            const marketingFunc = await DatabaseService.addFunction({
                companyId: companyId,
                name: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥",
                description: "–†–µ–∫–ª–∞–º–∞ —Ç–∞ –ø—Ä–æ–º–æ—Ü—ñ—è",
                color: "#e74c3c",
                assigneeIds: []
            });

            const salesFunc = await DatabaseService.addFunction({
                companyId: companyId,
                name: "–ü—Ä–æ–¥–∞–∂—ñ", 
                description: "–†–æ–±–æ—Ç–∞ –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏",
                color: "#27ae60",
                assigneeIds: []
            });

            console.log('–°—Ç–≤–æ—Ä–µ–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:', marketingFunc, salesFunc);

            // –°—Ç–≤–æ—Ä—é—î–º–æ –¥–µ–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const task1 = await DatabaseService.addTask({
                title: "–ê–Ω–∞–ª—ñ–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤",
                function: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥",
                assignee: currentUser?.name || "–í–ª–∞—Å–Ω–∏–∫",
                creator: currentUser?.name || "–í–ª–∞—Å–Ω–∏–∫", 
                deadline: tomorrow.toISOString(),
                status: "new",
                type: "single",
                priority: "high",
                pinned: false,
                additionalInfo: "–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª—ñ–∑ —Ç–æ–ø-5 –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤",
                howToReport: "–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–∞ email",
                result: ""
            });

            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            const task2 = await DatabaseService.addTask({
                title: "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–µ–±-—Å–∞–π—Ç—É",
                function: "–ü—Ä–æ–¥–∞–∂—ñ",
                assignee: currentUser?.name || "–í–ª–∞—Å–Ω–∏–∫",
                creator: currentUser?.name || "–í–ª–∞—Å–Ω–∏–∫",
                deadline: nextWeek.toISOString(),
                status: "progress",
                type: "regular", 
                priority: "medium",
                pinned: true,
                additionalInfo: "–û–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Ç–∞ –¥–∏–∑–∞–π–Ω –≥–æ–ª–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏",
                howToReport: "–ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –≤ —á–∞—Ç –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è",
                result: ""
            });

            console.log('–°—Ç–≤–æ—Ä–µ–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:', task1, task2);
            
            return { functions: [marketingFunc, salesFunc], tasks: [task1, task2] };
        }

        async function showCompanySelect(userEmail) {
            try {
                const userCompanies = await DatabaseService.getCompaniesForUser(userEmail);
                
                if (userCompanies.length === 0) {
                    // –ù–µ–º–∞—î –∫–æ–º–ø–∞–Ω—ñ–π - –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                    alert('‚ùå –î–ª—è –≤–∞—à–æ–≥–æ email –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó.\n\n–ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–∏ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É.');
                    backToLogin();
                    return;
                }

                if (userCompanies.length === 1) {
                    // –û–¥–Ω–∞ –∫–æ–º–ø–∞–Ω—ñ—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±—Ä–∞—Ç–∏
                    await selectCompany(userCompanies[0]);
                    return;
                }

                // –ö—ñ–ª—å–∫–∞ –∫–æ–º–ø–∞–Ω—ñ–π - –ø–æ–∫–∞–∑–∞—Ç–∏ –≤–∏–±—ñ—Ä
                const companiesList = document.getElementById('companiesList');
                companiesList.innerHTML = userCompanies.map(company => `
                    <div onclick="selectCompany('${company.id}')" 
                         style="background: #f8f9fa; border: 2px solid #ecf0f1; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s;"
                         onmouseover="this.style.borderColor='#3498db'" 
                         onmouseout="this.style.borderColor='#ecf0f1'">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">${company.name || '–ù–æ–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—è'}</h4>
                        <p style="color: #7f8c8d; font-size: 0.9rem;">–ü–ª–∞–Ω: ${company.plan} ‚Ä¢ –°—Ç–≤–æ—Ä–µ–Ω–æ: ${new Date(company.createdAt).toLocaleDateString('uk-UA')}</p>
                    </div>
                `).join('');

                document.getElementById('codeForm').style.display = 'none';
                document.getElementById('companySelectForm').style.display = 'block';

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–º–ø–∞–Ω—ñ–π:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–º–ø–∞–Ω—ñ–π');
            }
        }

        async function selectCompany(companyIdOrObject) {
            try {
                let company;
                if (typeof companyIdOrObject === 'string') {
                    // –Ø–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ ID, –∑–Ω–∞–π—Ç–∏ –∫–æ–º–ø–∞–Ω—ñ—é
                    const companies = await DatabaseService.getCompaniesForUser(currentUser.email);
                    company = companies.find(c => c.id === companyIdOrObject);
                } else {
                    // –Ø–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ –æ–±'—î–∫—Ç –∫–æ–º–ø–∞–Ω—ñ—ó
                    company = companyIdOrObject;
                }

                if (!company) {
                    alert('–ö–æ–º–ø–∞–Ω—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }

                currentCompany = company;
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è —Ü—ñ—î—ó –∫–æ–º–ø–∞–Ω—ñ—ó
                const companyUsers = await DatabaseService.getUsersByCompany(company.id);
                const user = companyUsers.find(u => u.email === currentUser.email);
                
                if (!user) {
                    alert('–í–∏ –Ω–µ —î —É—á–∞—Å–Ω–∏–∫–æ–º —Ü—ñ—î—ó –∫–æ–º–ø–∞–Ω—ñ—ó');
                    return;
                }

                currentUser = user;

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–µ—Å—ñ—é
                localStorage.setItem('demo_session', JSON.stringify({
                    user: currentUser,
                    company: company,
                    loginTime: Date.now()
                }));

                showMainInterface();
                updateCompanyInfo();
                await loadCompanyData();
                renderTasks();

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–±–æ—Ä—É –∫–æ–º–ø–∞–Ω—ñ—ó:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–±–æ—Ä—É –∫–æ–º–ø–∞–Ω—ñ—ó');
            }
        }

        function updateCompanyInfo() {
            if (currentCompany) {
                document.getElementById('currentCompanyInfo').style.display = 'block';
                document.getElementById('currentCompanyName').textContent = currentCompany.name;
            } else {
                document.getElementById('currentCompanyInfo').style.display = 'none';
            }

            if (currentUser) {
                const roleText = {owner: '–í–ª–∞—Å–Ω–∏–∫', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}[currentUser.role];
                document.getElementById('currentUserName').textContent = currentUser.name;
                document.getElementById('currentUserRole').textContent = `(${roleText})`;
            }
        }

        async function loadCompanyData() {
            if (!currentCompany) return;

            try {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö –∫–æ–º–ø–∞–Ω—ñ—ó
                const [companyTasks, companyUsers, companyFunctions] = await Promise.all([
                    DatabaseService.getTasksByCompany(currentCompany.id),
                    DatabaseService.getUsersByCompany(currentCompany.id),
                    DatabaseService.getFunctionsByCompany(currentCompany.id)
                ]);

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö
                tasks = companyTasks || [];
                users = companyUsers || [];
                functions = companyFunctions || [];

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ–ª–µ–∫—Ç—ñ–≤
                updateSelects();

                console.log(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –¥–∞–Ω—ñ –¥–ª—è –∫–æ–º–ø–∞–Ω—ñ—ó ${currentCompany.name}:`, {
                    tasks: tasks.length,
                    users: users.length, 
                    functions: functions.length
                });

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ–º–ø–∞–Ω—ñ—ó:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ–º–ø–∞–Ω—ñ—ó');
            }
        }
        let isAuthenticated = false;
        let authCodes = {}; // –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∫–æ–¥—ñ–≤ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
        let inviteCodes = {}; // –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–ø—Ä–æ—à–µ–Ω—å
        let currentAuthEmail = '';
        let currentInviteCode = '';

        // üîí –°–ò–°–¢–ï–ú–ê –ü–†–ê–í –î–û–°–¢–£–ü–£
        function hasPermission(action) {
            const role = currentUser.role;
            const permissions = {
                owner: ['all'],
                manager: ['viewAll', 'createTasks', 'editTasks', 'deleteTasks', 'createRegular', 'assignFunctions', 'extendDeadlines', 'manageUsers'],
                employee: ['viewOwn', 'createTasks', 'editOwnTasks', 'changeStatus', 'comment']
            };
            return permissions[role]?.includes('all') || permissions[role]?.includes(action);
        }

        function canViewTask(task) {
            if (hasPermission('viewAll')) return true;
            if (hasPermission('viewOwn')) {
                return task.assignee === currentUser.name || task.creator === currentUser.name;
            }
            return false;
        }

        function canEditTask(task) {
            if (hasPermission('editTasks')) return true;
            if (hasPermission('editOwnTasks')) {
                return task.assignee === currentUser.name || task.creator === currentUser.name;
            }
            return false;
        }

        function canDeleteTask(task) {
            if (hasPermission('deleteTasks')) return true;
            return task.creator === currentUser.name;
        }

        function showPermissionError() {
            alert('‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó –¥—ñ—ó');
        }

        function updateCurrentUserInfo() {
            const roleText = {owner: '–í–ª–∞—Å–Ω–∏–∫', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}[currentUser.role] || '–ù–µ–≤—ñ–¥–æ–º–∞ —Ä–æ–ª—å';
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = `(${roleText})`;
        }

        // üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø –†–û–õ–ï–ô (—Ç–∏–º—á–∞—Å–æ–≤–æ)
        function switchUserForTesting() {
            const testUsers = [
                {name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", role: "owner"},
                {name: "–ú–∞—Ä—ñ—è –ü–µ—Ç—Ä–µ–Ω–∫–æ", role: "manager"},
                {name: "–Ü–≤–∞–Ω –ö–æ–≤–∞–ª–µ–Ω–∫–æ", role: "employee"}
            ];
            
            const currentIndex = testUsers.findIndex(u => u.name === currentUser.name);
            const nextIndex = (currentIndex + 1) % testUsers.length;
            currentUser = testUsers[nextIndex];
            
            updateCurrentUserInfo();
            renderTasks();
            alert(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞: ${currentUser.name} (${currentUser.role})`);
        }

        // üîê –§–£–ù–ö–¶–Ü–á –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á
        function checkAuthentication() {
            const session = localStorage.getItem('authSession');
            if (session) {
                const sessionData = JSON.parse(session);
                const user = users.find(u => u.email === sessionData.email);
                if (user) {
                    currentUser = user;
                    isAuthenticated = true;
                    showMainInterface();
                    updateCurrentUserInfo();
                    return;
                }
            }
            showAuthPage();
        }

        function showAuthPage() {
            document.getElementById('authPage').style.display = 'block';
            document.getElementById('mainInterface').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥—É
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('codeForm').style.display = 'none';
            document.getElementById('companySelectForm').style.display = 'none';
        }

        function showMainInterface() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('demo_session');
            isAuthenticated = false;
            currentUser = null;
            currentCompany = null;
            tasks = [];
            users = [];
            functions = [];
            showAuthPage();
            alert('üëã –î–æ –ø–æ–±–∞—á–µ–Ω–Ω—è!');
        }

        async function sendLoginCode() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                alert('–í–≤–µ–¥—ñ—Ç—å email');
                return;
            }

            const user = users.find(u => u.email === email);
            if (!user) {
                alert('‚ùå –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–∏–º email –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            authCodes[email] = {
                code: code,
                expiry: Date.now() + 10 * 60 * 1000 // 10 —Ö–≤–∏–ª–∏–Ω
            };
            
            currentAuthEmail = email;

            // –ü–æ–∫–∞–∑ –∫–æ–¥—É (–∑–∞–º—ñ—Å—Ç—å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ email)
            alert(`üìß –ö–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: ${code}\n(–í —Ä–µ–∞–ª—å–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å—Å—è –Ω–∞ email)`);

            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏—Å—å –Ω–∞ —Ñ–æ—Ä–º—É –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('codeForm').style.display = 'block';
        }

        function verifyLoginCode() {
            const enteredCode = document.getElementById('loginCode').value.trim();
            const authData = authCodes[currentAuthEmail];

            if (!authData) {
                alert('‚ùå –ö–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            if (Date.now() > authData.expiry) {
                alert('‚ùå –ö–æ–¥ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π');
                delete authCodes[currentAuthEmail];
                backToLogin();
                return;
            }

            if (enteredCode !== authData.code) {
                alert('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–æ–¥');
                return;
            }

            // –£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
            const user = users.find(u => u.email === currentAuthEmail);
            currentUser = user;
            isAuthenticated = true;

            // –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–µ—Å—ñ—é
            localStorage.setItem('authSession', JSON.stringify({
                email: currentAuthEmail,
                loginTime: Date.now()
            }));

            // –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ–¥
            delete authCodes[currentAuthEmail];

            showMainInterface();
            updateCurrentUserInfo();
            renderTasks();
            alert(`üéâ –í—ñ—Ç–∞—î–º–æ, ${currentUser.name}!`);
        }

        function backToLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('codeForm').style.display = 'none';
            document.getElementById('loginCode').value = '';
        }

        function logout() {
            localStorage.removeItem('authSession');
            isAuthenticated = false;
            currentUser = null;
            showAuthPage();
        }

        // üì§ –°–ò–°–¢–ï–ú–ê –ó–ê–ü–†–û–®–ï–ù–¨
        function openInviteModal() {
            if (!hasPermission('manageUsers')) {
                showPermissionError();
                return;
            }
            
            document.getElementById('inviteModal').style.display = 'block';
            updateInviteFunctionSelect();
            clearInviteForm();
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
        }

        function closeInviteLinkModal() {
            document.getElementById('inviteLinkModal').style.display = 'none';
        }

        function clearInviteForm() {
            document.getElementById('inviteEmail').value = '';
            document.getElementById('inviteRole').value = 'employee';
            document.getElementById('inviteFunction').value = '';
            document.getElementById('invitePosition').value = '';
            document.getElementById('inviteMessage').value = '';
        }

        function updateInviteFunctionSelect() {
            const select = document.getElementById('inviteFunction');
            select.innerHTML = '<option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' + 
                functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        function createInvite() {
            const email = document.getElementById('inviteEmail').value.trim();
            const role = document.getElementById('inviteRole').value;
            const functionName = document.getElementById('inviteFunction').value;
            const position = document.getElementById('invitePosition').value.trim();
            const message = document.getElementById('inviteMessage').value.trim();

            if (!email) {
                alert('–í–≤–µ–¥—ñ—Ç—å email —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —ñ—Å–Ω—É—î
            const existingUser = users.find(u => u.email === email);
            if (existingUser) {
                alert('‚ùå –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ —ñ—Å–Ω—É—î –≤ —Å–∏—Å—Ç–µ–º—ñ');
                return;
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è
            const inviteCode = 'INV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è
            inviteCodes[inviteCode] = {
                email: email,
                role: role,
                function: functionName,
                position: position,
                message: message,
                invitedBy: currentUser.name,
                createdAt: Date.now(),
                expiresAt: Date.now() + 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω—ñ–≤
                used: false
            };

            localStorage.setItem('inviteCodes', JSON.stringify(inviteCodes));

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è
            const currentUrl = window.location.origin + window.location.pathname;
            const inviteLink = `${currentUrl}?invite=${inviteCode}`;
            
            currentInviteCode = inviteCode;
            document.getElementById('inviteLinkText').textContent = inviteLink;

            closeInviteModal();
            document.getElementById('inviteLinkModal').style.display = 'block';
        }

        function copyInviteLink() {
            const linkText = document.getElementById('inviteLinkText').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                alert('üìã –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!');
            }).catch(() => {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
                const textArea = document.createElement('textarea');
                textArea.value = linkText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('üìã –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
            });
        }

        function shareInviteEmail() {
            const invite = inviteCodes[currentInviteCode];
            const linkText = document.getElementById('inviteLinkText').textContent;
            
            const subject = encodeURIComponent('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥–æ TALKO System');
            const body = encodeURIComponent(`–í—ñ—Ç–∞—î–º–æ!

–í–∞—Å –∑–∞–ø—Ä–æ—à—É—é—Ç—å –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Å–∏—Å—Ç–µ–º–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏ TALKO System.

${invite.message ? '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: ' + invite.message + '\n\n' : ''}–†–æ–ª—å: ${invite.role === 'manager' ? '–ú–µ–Ω–µ–¥–∂–µ—Ä' : '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}
${invite.position ? '–ü–æ—Å–∞–¥–∞: ' + invite.position + '\n' : ''}${invite.function ? '–§—É–Ω–∫—Ü—ñ—è: ' + invite.function + '\n' : ''}
–î–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –ø–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º:
${linkText}

–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥—ñ—î 7 –¥–Ω—ñ–≤.

–ó –ø–æ–≤–∞–≥–æ—é,
–ö–æ–º–∞–Ω–¥–∞ TALKO System`);

            const mailtoLink = `mailto:${invite.email}?subject=${subject}&body=${body}`;
            window.open(mailtoLink);
        }

        function showInviteForm(inviteCode) {
            const invite = inviteCodes[inviteCode];
            
            if (!invite) {
                alert('‚ùå –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–µ');
                showAuthPage();
                return;
            }

            if (invite.used) {
                alert('‚ùå –¶–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ');
                showAuthPage();
                return;
            }

            if (Date.now() > invite.expiresAt) {
                alert('‚ùå –¢–µ—Ä–º—ñ–Ω –¥—ñ—ó –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –º–∏–Ω—É–≤');
                showAuthPage();
                return;
            }

            // –ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ–æ—Ä–º—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('inviteForm').style.display = 'block';
            
            currentInviteCode = inviteCode;
        }

        function completeRegistration() {
            const name = document.getElementById('inviteName').value.trim();
            const phone = document.getElementById('invitePhone').value.trim();

            if (!name) {
                alert('–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ');
                return;
            }

            const invite = inviteCodes[currentInviteCode];
            if (!invite) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è');
                return;
            }

            // –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            const newUser = {
                id: Math.max(...users.map(u => u.id || 0), 0) + 1,
                name: name,
                email: invite.email,
                phone: phone,
                role: invite.role,
                position: invite.position || '',
                department: invite.function || '',
                notes: `–ü—Ä–∏—î–¥–Ω–∞–≤—Å—è –∑–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º –≤—ñ–¥ ${invite.invitedBy}`
            };

            users.push(newUser);

            // –î–æ–¥–∞—Ç–∏ –¥–æ —Ñ—É–Ω–∫—Ü—ñ—ó —è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ
            if (invite.function) {
                const func = functions.find(f => f.name === invite.function);
                if (func && !func.assignees.includes(name)) {
                    func.assignees.push(name);
                }
            }

            // –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è —è–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–µ
            invite.used = true;
            invite.usedAt = Date.now();

            // –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            currentUser = newUser;
            isAuthenticated = true;

            // –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('functions', JSON.stringify(functions));
            localStorage.setItem('inviteCodes', JSON.stringify(inviteCodes));
            localStorage.setItem('authSession', JSON.stringify({
                email: newUser.email,
                loginTime: Date.now()
            }));

            showMainInterface();
            updateCurrentUserInfo();
            renderTasks();
            alert(`üéâ –í—ñ—Ç–∞—î–º–æ –≤ –∫–æ–º–∞–Ω–¥—ñ, ${newUser.name}!`);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ó–∞–ø—É—Å–∫ TALKO System SaaS');
            
            // –¢–ï–°–¢–£–í–ê–ù–ù–Ø: –û—á–∏—â–∞—î–º–æ —Å–µ—Å—ñ—é –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–ª—è –¥–µ–º–æ
            if (window.location.hash === '#demo') {
                console.log('Demo —Ä–µ–∂–∏–º - –æ—á–∏—â–∞—î–º–æ —Å–µ—Å—ñ—é');
                localStorage.removeItem('demo_session');
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (Firebase + –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω—ñ—Å—Ç—å)
            checkAuthentication();
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–æ–≤–∏
            setLanguage(currentLanguage);
            updatePageContent();

            // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Ñ–æ—Ä–º
            ['taskForm','functionForm','regularTaskForm','userForm','inviteFormModal'].forEach(id => {
                const form = document.getElementById(id);
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        if(id==='taskForm') saveTask();
                        else if(id==='functionForm') saveFunction();
                        else if(id==='regularTaskForm') saveRegularTask();
                        else if(id==='userForm') saveUser();
                        else if(id==='inviteFormModal') createInvite();
                    });
                }
            });
        });

        // üóëÔ∏è –í–ò–î–ê–õ–Ø–Ñ–ú–û –°–¢–ê–†–Ü localStorage –§–£–ù–ö–¶–Ü–á
        // –¢–µ–ø–µ—Ä –≤—Å–µ –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ Firebase/DatabaseService
        
        function loadData() {
            // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è —Ç–µ–ø–µ—Ä –ø—É—Å—Ç–∞ - –¥–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ loadCompanyData()
            console.log('üìÇ –î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ Firebase...');
        }

        function saveData() {
            // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è —Ç–µ–ø–µ—Ä –ø—É—Å—Ç–∞ - –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ DatabaseService
            console.log('üíæ –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ Firebase...');
        }

        function switchTab(tabName) {
            activeTab = tabName;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            switch(tabName) {
                case 'tasks': renderTasks(); break;
                case 'control': 
                    updateControlFilters(); // üîÑ –û–ù–û–í–õ–Æ–Ñ–ú–û –§–Ü–õ–¨–¢–†–ò
                    renderControlDashboard(); 
                    break;
                case 'regular': 
                    updateRegularFilters(); // üîÑ –û–ù–û–í–õ–Æ–Ñ–ú–û –§–Ü–õ–¨–¢–†–ò
                    renderRegularTasks(); 
                    break;
                case 'functions': renderFunctions(); break;
                case 'users': 
                    updateUserFilters(); // üîÑ –û–ù–û–í–õ–Æ–Ñ–ú–û –§–Ü–õ–¨–¢–†–ò
                    renderUsers(); 
                    break;
                case 'analytics': renderAnalytics(); break;
            }
        }

        function openTaskModal(taskId = null) {
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task && !canEditTask(task)) {
                    showPermissionError();
                    return;
                }
            } else {
                if (!hasPermission('createTasks')) {
                    showPermissionError();
                    return;
                }
            }
            
            document.getElementById('taskModal').style.display = 'block';
            if (taskId) {
                editingTaskId = taskId;
                fillTaskForm(taskId);
                document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è';
            } else {
                editingTaskId = null;
                clearTaskForm();
                document.getElementById('modalTitle').textContent = '–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è';
            }
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
        }

        function clearTaskForm() {
            ['taskTitle','taskFunction','taskAssignee','taskDeadline','taskInfo','taskReporting','taskResult'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('taskType').value = 'single';
            document.getElementById('taskStatus').value = 'new';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskPinned').checked = false;
        }

        function fillTaskForm(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskFunction').value = task.function || '';
                document.getElementById('taskAssignee').value = task.assignee;
                document.getElementById('taskDeadline').value = task.deadline;
                document.getElementById('taskType').value = task.type;
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskPriority').value = task.priority || 'medium';
                document.getElementById('taskPinned').checked = task.pinned || false;
                document.getElementById('taskInfo').value = task.additionalInfo || '';
                document.getElementById('taskReporting').value = task.howToReport || '';
                document.getElementById('taskResult').value = task.result || '';
            }
        }

        async function saveTask() {
            const data = {
                title: document.getElementById('taskTitle').value,
                function: document.getElementById('taskFunction').value,
                assignee: document.getElementById('taskAssignee').value,
                deadline: document.getElementById('taskDeadline').value,
                duration: document.getElementById('taskDuration').value,
                type: document.getElementById('taskType').value,
                status: document.getElementById('taskStatus').value,
                priority: document.getElementById('taskPriority').value,
                pinned: document.getElementById('taskPinned').checked,
                additionalInfo: document.getElementById('taskInfo').value,
                howToReport: document.getElementById('taskReporting').value,
                result: document.getElementById('taskResult').value,
                creator: '–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ' // –ü—Ä–æ—Å—Ç–∏–π —Ñ—ñ–∫—Å –±–µ–∑ currentUser
            };

            if (!data.title || !data.assignee || !data.deadline || !data.duration) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
                return;
            }

            try {
                if (editingTaskId) {
                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è
                    const idx = tasks.findIndex(t => t.id === editingTaskId);
                    if (idx !== -1) {
                        tasks[idx] = {...tasks[idx], ...data};
                    }
                    alert('–ó–∞–≤–¥–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ');
                } else {
                    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –ë–ï–ó DatabaseService
                    const newTask = {
                        id: Date.now(),
                        createdDate: new Date().toISOString(),
                        ...data
                    };
                    tasks.push(newTask);
                    alert('–ó–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ');
                }

                renderTasks();
                closeTaskModal();
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è');
            }
        }

        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && !canDeleteTask(task)) {
                showPermissionError();
                return;
            }
            
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è?')) {
                try {
                    await DatabaseService.deleteTask(taskId);
                    tasks = tasks.filter(t => t.id !== taskId);
                    renderTasks();
                    alert('–ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ');
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è:', error);
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è');
                }
            }
        }

        function togglePinTask(taskId) {
            const idx = tasks.findIndex(t => t.id === taskId);
            if (idx !== -1) {
                tasks[idx].pinned = !tasks[idx].pinned;
                saveData();
                renderTasks();
                alert(tasks[idx].pinned ? '–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ' : '–í—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–æ');
            }
        }

        function getFilteredTasks() {
            const filters = {
                pinned: document.getElementById('pinnedFilter')?.value,
                date: document.getElementById('dateFilter')?.value,
                status: document.getElementById('statusFilter')?.value,
                function: document.getElementById('functionFilter')?.value,
                assignee: document.getElementById('assigneeFilter')?.value
            };

            return tasks.filter(task => {
                // üîí –ü–ï–†–ï–í–Ü–†–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–£
                if (!canViewTask(task)) return false;

                const matchesPinned = !filters.pinned || 
                    (filters.pinned === 'pinned' && task.pinned) ||
                    (filters.pinned === 'unpinned' && !task.pinned);

                let matchesDate = true;
                if (filters.date) {
                    const taskDate = new Date(task.deadline);
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    switch(filters.date) {
                        case 'today':
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            matchesDate = taskDate >= today && taskDate < tomorrow;
                            break;
                        case 'week':
                            const weekEnd = new Date(today);
                            weekEnd.setDate(weekEnd.getDate() + 7);
                            matchesDate = taskDate >= today && taskDate < weekEnd;
                            break;
                        case 'month':
                            const monthEnd = new Date(today);
                            monthEnd.setMonth(monthEnd.getMonth() + 1);
                            matchesDate = taskDate >= today && taskDate < monthEnd;
                            break;
                        case 'overdue':
                            matchesDate = taskDate < now && task.status !== 'done';
                            break;
                        case 'custom':
                            const dateFrom = document.getElementById('dateFrom')?.value;
                            const dateTo = document.getElementById('dateTo')?.value;
                            if (dateFrom && dateTo) {
                                const fromDate = new Date(dateFrom);
                                const toDate = new Date(dateTo + 'T23:59:59');
                                matchesDate = taskDate >= fromDate && taskDate <= toDate;
                            }
                            break;
                    }
                }

                return matchesPinned && matchesDate && 
                       (!filters.status || task.status === filters.status) &&
                       (!filters.function || task.function === filters.function) &&
                       (!filters.assignee || task.assignee === filters.assignee);
            });
        }

        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter')?.value;
            const dateRangeInputs = document.getElementById('dateRangeInputs');
            if (dateRangeInputs) {
                dateRangeInputs.style.display = dateFilter === 'custom' ? 'flex' : 'none';
            }
            renderTasks();
        }

        function clearFilters() {
            ['pinnedFilter','dateFilter','statusFilter','functionFilter','assigneeFilter','dateFrom','dateTo'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            document.getElementById('dateRangeInputs').style.display = 'none';
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            const filtered = getFilteredTasks();
            const sorted = [...filtered].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(a.deadline) - new Date(b.deadline);
            });

            const headers = updateTaskHeaders();

            if (sorted.length === 0) {
                container.innerHTML = `
                    <div class="task-header">
                        <div>${headers[0]}</div><div>${headers[1]}</div><div>${headers[2]}</div>
                        <div>${headers[3]}</div><div>${headers[4]}</div><div>${headers[5]}</div><div>${headers[6]}</div>
                    </div>
                    <div class="empty-state">
                        <h3>${currentLanguage === 'ru' ? '–ó–∞–¥–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : currentLanguage === 'bg' ? '–ó–∞–¥–∞—á–∏ –Ω–µ —Å–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏' : currentLanguage === 'en' ? 'No tasks found' : '–ó–∞–≤–¥–∞–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'}</h3>
                        <p>${currentLanguage === 'ru' ? '–ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É' : currentLanguage === 'bg' ? '–ü—Ä–æ–º–µ–Ω–µ—Ç–µ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ –∏–ª–∏ –¥–æ–±–∞–≤–µ—Ç–µ –Ω–æ–≤–∞ –∑–∞–¥–∞—á–∞' : currentLanguage === 'en' ? 'Change filters or add a new task' : '–ó–º—ñ–Ω—ñ—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –Ω–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è'}</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="task-header">
                    <div>${headers[0]}</div><div>${headers[1]}</div><div>${headers[2]}</div>
                    <div>${headers[3]}</div><div>${headers[4]}</div><div>${headers[5]}</div><div>${headers[6]}</div>
                </div>
                ${sorted.map(task => `
                    <div class="task-row ${task.pinned ? 'pinned' : ''}">
                        <div>
                            <div class="task-title-container">
                                <button class="pin-btn ${task.pinned ? 'pinned' : ''}" onclick="togglePinTask(${task.id})" title="${task.pinned ? (currentLanguage === 'ru' ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : currentLanguage === 'bg' ? '–û—Ç–∫–∞—á–∏' : currentLanguage === 'en' ? 'Unpin' : '–í—ñ–¥–∫—Ä—ñ–ø–∏—Ç–∏') : (currentLanguage === 'ru' ? '–ó–∞–∫—Ä–µ–ø–∏—Ç—å' : currentLanguage === 'bg' ? '–ó–∞–∫–∞—á–∏' : currentLanguage === 'en' ? 'Pin' : '–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏')}">üìå</button>
                                <div class="task-title">${task.title}</div>
                            </div>
                            ${task.additionalInfo ? `<div class="task-info">${task.additionalInfo}</div>` : ''}
                        </div>
                        <div>${task.assignee}</div>
                        <div>${task.creator}</div>
                        <div>${formatDateTime(task.deadline)}</div>
                        <div><span class="status-badge status-${task.status}">${getStatusText(task.status)}</span></div>
                        <div><span class="type-badge type-${task.type}">${getTypeText(task.type)}</span></div>
                        <div>
                            ${canEditTask(task) ? `<button class="btn btn-small" onclick="openTaskModal(${task.id})" title="${currentLanguage === 'ru' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : currentLanguage === 'bg' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π' : currentLanguage === 'en' ? 'Edit' : '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏'}">‚úèÔ∏è</button>` : ''}
                            ${canDeleteTask(task) ? `<button class="btn btn-small btn-danger" onclick="deleteTask(${task.id})" style="margin-left: 0.3rem;" title="${currentLanguage === 'ru' ? '–£–¥–∞–ª–∏—Ç—å' : currentLanguage === 'bg' ? '–ò–∑—Ç—Ä–∏–π' : currentLanguage === 'en' ? 'Delete' : '–í–∏–¥–∞–ª–∏—Ç–∏'}">üóëÔ∏è</button>` : ''}
                            ${!canEditTask(task) && !canDeleteTask(task) ? `<span style="color: #7f8c8d; font-size: 0.8rem;">${currentLanguage === 'ru' ? '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä' : currentLanguage === 'bg' ? '–°–∞–º–æ –ø—Ä–µ–≥–ª–µ–¥' : currentLanguage === 'en' ? 'View only' : '–¢—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥'}</span>` : ''}
                        </div>
                    </div>
                `).join('')}`;
        }

        function openFunctionModal() {
            // –°–∫–∏–¥–∞—î–º–æ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            window.editingFunctionId = null;
            document.querySelector('#functionModal .modal-header h2').textContent = '–î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é';
            
            document.getElementById('functionModal').style.display = 'block';
            updateFunctionAssigneesList();
            clearFunctionForm();
        }

        function editFunction(functionId) {
            const func = functions.find(f => f.id === functionId);
            if (!func) return;

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Ñ–æ—Ä–º—É –¥–∞–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—ó
            document.getElementById('functionName').value = func.name;
            document.getElementById('functionDepartment').value = func.department || ''; // üÜï –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢
            document.getElementById('functionColor').value = func.color;
            document.getElementById('functionDescription').value = func.description;

            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ –≤–∂–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–º–∏
            updateFunctionAssigneesList();
            
            // –í—ñ–¥–º—ñ—á–∞—î–º–æ –≤–∂–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
            setTimeout(() => {
                const checkboxes = document.querySelectorAll('#functionAssignees input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = func.assignees.includes(checkbox.value);
                });
            }, 100);

            // –ó–º—ñ–Ω—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
            document.querySelector('#functionModal .modal-header h2').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é';

            // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
            document.getElementById('functionModal').style.display = 'block';

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
            window.editingFunctionId = functionId;
        }

        function closeFunctionModal() {
            document.getElementById('functionModal').style.display = 'none';
        }

        function clearFunctionForm() {
            document.getElementById('functionName').value = '';
            document.getElementById('functionDepartment').value = ''; // üÜï –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢
            document.getElementById('functionColor').value = '#3498db';
            document.getElementById('functionDescription').value = '';
            document.querySelectorAll('#functionAssignees input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function updateFunctionAssigneesList() {
            document.getElementById('functionAssignees').innerHTML = users.map(user => `
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.3rem 0;">
                    <input type="checkbox" value="${user.name}">
                    <span>${user.name}</span>
                </label>
            `).join('');
        }

        function saveFunction() {
            const data = {
                name: document.getElementById('functionName').value.trim(),
                department: document.getElementById('functionDepartment').value.trim(), // üÜï –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢
                color: document.getElementById('functionColor').value,
                description: document.getElementById('functionDescription').value.trim(),
                assignees: Array.from(document.querySelectorAll('#functionAssignees input[type="checkbox"]:checked')).map(cb => cb.value)
            };

            if (!data.name) {
                alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ñ—É–Ω–∫—Ü—ñ—ó');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ–º'—è –Ω–µ –∑–∞–π–Ω—è—Ç–µ —ñ–Ω—à–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é
            const existingFunction = functions.find(f => f.name === data.name && f.id !== window.editingFunctionId);
            if (existingFunction) {
                alert('–§—É–Ω–∫—Ü—ñ—è –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é –≤–∂–µ —ñ—Å–Ω—É—î');
                return;
            }

            if (window.editingFunctionId) {
                // –û–Ω–æ–≤–ª—é—î–º–æ —ñ—Å–Ω—É—é—á—É —Ñ—É–Ω–∫—Ü—ñ—é
                const idx = functions.findIndex(f => f.id === window.editingFunctionId);
                if (idx !== -1) {
                    const oldName = functions[idx].name;
                    
                    functions[idx] = {
                        ...functions[idx],
                        ...data
                    };

                    // –Ø–∫—â–æ –∑–º—ñ–Ω–∏–ª–∞—Å—å –Ω–∞–∑–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—ó - –æ–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è
                    if (oldName !== data.name) {
                        tasks.forEach(task => {
                            if (task.function === oldName) {
                                task.function = data.name;
                            }
                        });
                        regularTasks.forEach(task => {
                            if (task.function === oldName) {
                                task.function = data.name;
                            }
                        });
                    }

                    alert('‚úÖ –§—É–Ω–∫—Ü—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä ' + data.assignees.length + ' —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ.');
                }
                window.editingFunctionId = null;
            } else {
                // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é
                functions.push({id: Date.now(), ...data});
                alert('–§—É–Ω–∫—Ü—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ');
            }

            saveData();
            updateSelects();
            updateRegularFilters(); // üîÑ –û–ù–û–í–õ–Æ–Ñ–ú–û –§–Ü–õ–¨–¢–†–ò –†–ï–ì–£–õ–Ø–†–ù–ò–•
            updateControlFilters(); // üîÑ –û–ù–û–í–õ–Æ–Ñ–ú–û –§–Ü–õ–¨–¢–†–ò –ö–û–ù–¢–†–û–õ–Æ
            updateUserFilters(); // üîÑ –û–ù–û–í–õ–Æ–Ñ–ú–û –§–Ü–õ–¨–¢–†–ò –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í
            renderFunctions();
            closeFunctionModal();
        }

        function deleteFunction(functionId) {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é?')) {
                functions = functions.filter(f => f.id !== functionId);
                saveData();
                updateSelects();
                renderFunctions();
                alert('–§—É–Ω–∫—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ');
            }
        }

        function renderFunctions() {
            const container = document.getElementById('functionsContainer');
            if (functions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–§—É–Ω–∫—Ü—ñ—ó –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó</h3>
                        <p>–î–æ–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞–Ω–Ω—è —Ä–æ–±–æ—Ç–∏</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="function-cards">
                    ${functions.map(func => `
                        <div class="function-card">
                            <div class="function-title" style="color: ${func.color};">${func.name}</div>
                            ${func.department ? `<div style="font-size: 0.8rem; color: #7f8c8d; margin-bottom: 0.5rem;">üè¢ ${func.department}</div>` : ''}
                            <div class="function-description">${func.description}</div>
                            <div class="function-assignees">
                                ${func.assignees.map(a => `<span class="assignee-badge">${a}</span>`).join('')}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                                <span class="function-tasks-count">–ó–∞–≤–¥–∞–Ω—å: ${tasks.filter(t => t.function === func.name).length}</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-small" style="background: #3498db; color: white;" onclick="editFunction(${func.id})">‚úèÔ∏è</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteFunction(${func.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function openRegularTaskModal() {
            if (!hasPermission('createRegular')) {
                showPermissionError();
                return;
            }
            document.getElementById('regularTaskModal').style.display = 'block';
            clearRegularTaskForm();
            updateRegularTaskSelects();
        }

        function closeRegularTaskModal() {
            document.getElementById('regularTaskModal').style.display = 'none';
        }

        function clearRegularTaskForm() {
            document.getElementById('regularTaskTitle').value = '';
            document.getElementById('regularTaskFunction').value = '';
            document.getElementById('regularTaskAssignee').value = '';
            document.getElementById('regularTaskPeriod').value = 'weekly';
            document.getElementById('regularTaskDuration').value = '1';
            document.getElementById('regularTaskDescription').value = '';
            document.getElementById('customDaysContainer').style.display = 'none';
            document.querySelectorAll('input[name="customDays"]').forEach(cb => cb.checked = false);
        }

        function updatePeriodOptions() {
            const period = document.getElementById('regularTaskPeriod').value;
            const customDaysContainer = document.getElementById('customDaysContainer');
            
            if (period === 'custom') {
                customDaysContainer.style.display = 'block';
            } else {
                customDaysContainer.style.display = 'none';
                // –û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ
                document.querySelectorAll('input[name="customDays"]').forEach(cb => cb.checked = false);
            }
        }

        function updateRegularTaskSelects() {
            document.getElementById('regularTaskFunction').innerHTML = '<option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' + 
                functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            document.getElementById('regularTaskAssignee').innerHTML = '<option value="">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</option>' + 
                users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        }

        function saveRegularTask() {
            const period = document.getElementById('regularTaskPeriod').value;
            let customDays = [];
            
            if (period === 'custom') {
                customDays = Array.from(document.querySelectorAll('input[name="customDays"]:checked')).map(cb => parseInt(cb.value));
                if (customDays.length === 0) {
                    alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –¥–µ–Ω—å –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è');
                    return;
                }
            }
            
            const data = {
                title: document.getElementById('regularTaskTitle').value.trim(),
                function: document.getElementById('regularTaskFunction').value,
                assignee: document.getElementById('regularTaskAssignee').value,
                period: period,
                customDays: customDays,
                duration: parseInt(document.getElementById('regularTaskDuration').value),
                description: document.getElementById('regularTaskDescription').value.trim()
            };

            if (!data.title || !data.assignee) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ –≤–∏–∫–æ–Ω–∞–≤—Ü—è');
                return;
            }

            regularTasks.push({
                id: Date.now(),
                createdDate: new Date().toISOString(),
                lastGenerated: null,
                active: true,
                ...data
            });
            
            saveData();
            renderRegularTasks();
            closeRegularTaskModal();
            alert('–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ');
        }

        function generateTaskFromRegular(regularTaskId) {
            const rt = regularTasks.find(r => r.id === regularTaskId);
            if (!rt) return;

            const now = new Date();
            const deadline = new Date(now);
            deadline.setDate(deadline.getDate() + rt.duration);

            tasks.push({
                id: Date.now(),
                title: rt.title,
                function: rt.function,
                assignee: rt.assignee,
                creator: currentUser.name,
                createdDate: now.toISOString(),
                deadline: deadline.toISOString(),
                status: 'new',
                type: 'regular',
                priority: 'medium',
                pinned: false,
                additionalInfo: rt.description,
                howToReport: '',
                result: ''
            });

            const idx = regularTasks.findIndex(r => r.id === regularTaskId);
            if (idx !== -1) regularTasks[idx].lastGenerated = now.toISOString();

            saveData();
            renderRegularTasks();
            alert(`–°—Ç–≤–æ—Ä–µ–Ω–æ: ${rt.title}`);
        }

        function deleteRegularTask(regularTaskId) {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è?')) {
                regularTasks = regularTasks.filter(rt => rt.id !== regularTaskId);
                saveData();
                renderRegularTasks();
                alert('–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ');
            }
        }

        // üîç –§–Ü–õ–¨–¢–†–ò –†–ï–ì–£–õ–Ø–†–ù–ò–• –ó–ê–í–î–ê–ù–¨
        function updateRegularFilters() {
            const assigneeFilter = document.getElementById('regularAssigneeFilter');
            const functionFilter = document.getElementById('regularFunctionFilter');

            if (assigneeFilter) {
                assigneeFilter.innerHTML = '<option value="">–í—Å—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>';
                // –î–æ–¥–∞—î–º–æ –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
                users.forEach(user => {
                    assigneeFilter.innerHTML += `<option value="${user.name}">${user.name}</option>`;
                });
            }

            if (functionFilter) {
                functionFilter.innerHTML = '<option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option>';
                // –î–æ–¥–∞—î–º–æ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
                functions.forEach(func => {
                    functionFilter.innerHTML += `<option value="${func.name}">${func.name}</option>`;
                });
            }
        }

        function filterRegularTasks() {
            const assigneeFilter = document.getElementById('regularAssigneeFilter').value;
            const functionFilter = document.getElementById('regularFunctionFilter').value;

            // –ü—Ä–æ—Å—Ç–∏–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å—ñ—Ö –∑–∞–≤–¥–∞–Ω—å (–ø–æ–∫–∏ —â–æ –±–µ–∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó)
            renderRegularTasks();
        }

        function clearRegularFilters() {
            document.getElementById('regularAssigneeFilter').value = '';
            document.getElementById('regularFunctionFilter').value = '';
            renderRegularTasks();
        }

        function renderRegularTasks() {
            const container = document.getElementById('regularTasksContainer');
            if (regularTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–†–µ–≥—É–ª—è—Ä–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
                        <p>–î–æ–¥–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="regular-tasks-grid">
                    ${regularTasks.map(rt => {
                        let periodText = '';
                        const dayNames = ['–ù–µ–¥—ñ–ª—è', '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', '–ü\'—è—Ç–Ω–∏—Ü—è', '–°—É–±–æ—Ç–∞'];
                        
                        switch(rt.period) {
                            case 'daily': periodText = '—â–æ–¥–Ω—è'; break;
                            case 'weekly': periodText = '—â–æ—Ç–∏–∂–Ω—è'; break;
                            case 'monthly': periodText = '—â–æ–º—ñ—Å—è—Ü—è'; break;
                            case 'workdays': periodText = '—Ä–æ–±–æ—á—ñ –¥–Ω—ñ (–ü–Ω-–ü—Ç)'; break;
                            case 'weekends': periodText = '–≤–∏—Ö—ñ–¥–Ω—ñ (–°–±-–ù–¥)'; break;
                            case 'custom': 
                                if (rt.customDays && rt.customDays.length > 0) {
                                    const selectedDays = rt.customDays.map(d => dayNames[d]).join(', ');
                                    periodText = `–≤–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ: ${selectedDays}`;
                                } else {
                                    periodText = '–≤–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ';
                                }
                                break;
                            default: periodText = rt.period;
                        }

                        const lastGenerated = rt.lastGenerated ? new Date(rt.lastGenerated).toLocaleDateString('uk-UA') : '–ù—ñ–∫–æ–ª–∏';

                        return `
                            <div class="regular-task-card">
                                <div class="regular-task-header">
                                    <div class="regular-task-title">${rt.title}</div>
                                </div>
                                <div class="regular-task-info">
                                    <div><strong>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:</strong> ${rt.assignee}</div>
                                    <div><strong>–§—É–Ω–∫—Ü—ñ—è:</strong> ${rt.function || '–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó'}</div>
                                    <div><strong>–ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ—Å—Ç—å:</strong> ${periodText}</div>
                                    <div><strong>–î–Ω—ñ–≤ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</strong> ${rt.duration}</div>
                                    <div><strong>–û—Å—Ç–∞–Ω–Ω—î —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:</strong> ${lastGenerated}</div>
                                    ${rt.description ? `<div><strong>–û–ø–∏—Å:</strong> ${rt.description}</div>` : ''}
                                </div>
                                <div class="regular-task-actions">
                                    <button class="btn btn-small btn-success" onclick="generateTaskFromRegular(${rt.id})">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteRegularTask(${rt.id})">üóëÔ∏è</button>
                                </div>
                            </div>`;
                    }).join('')}
                </div>`;
        }

        // üîç –§–Ü–õ–¨–¢–†–ò –ö–û–ù–¢–†–û–õ–Æ
        function updateControlFilters() {
            const assigneeFilter = document.getElementById('controlAssigneeFilter');
            const functionFilter = document.getElementById('controlFunctionFilter');

            if (assigneeFilter) {
                assigneeFilter.innerHTML = '<option value="">–í—Å—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>';
                users.forEach(user => {
                    assigneeFilter.innerHTML += `<option value="${user.name}">${user.name}</option>`;
                });
            }

            if (functionFilter) {
                functionFilter.innerHTML = '<option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option>';
                functions.forEach(func => {
                    functionFilter.innerHTML += `<option value="${func.name}">${func.name}</option>`;
                });
            }
        }

        function updateControlPanel() {
            const assigneeFilter = document.getElementById('controlAssigneeFilter')?.value || '';
            const functionFilter = document.getElementById('controlFunctionFilter')?.value || '';
            const periodFilter = document.getElementById('controlPeriodFilter')?.value || 'all';

            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è
            let filteredTasks = tasks.filter(task => {
                if (assigneeFilter && task.assignee !== assigneeFilter) return false;
                if (functionFilter && task.function !== functionFilter) return false;
                
                // –§—ñ–ª—å—Ç—Ä –ø–æ –ø–µ—Ä—ñ–æ–¥—É
                if (periodFilter !== 'all') {
                    const taskDate = new Date(task.deadline || task.createdDate);
                    const now = new Date();
                    
                    if (periodFilter === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (taskDate < weekAgo) return false;
                    } else if (periodFilter === 'month') {
                        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        if (taskDate < monthAgo) return false;
                    }
                }
                
                return true;
            });

            // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
            const now = new Date();
            const urgent = filteredTasks.filter(t => new Date(t.deadline) < now && t.status !== 'done').length;
            const warning = filteredTasks.filter(t => {
                const deadline = new Date(t.deadline);
                const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                return deadline <= tomorrow && deadline >= now && t.status !== 'done';
            }).length;
            const active = filteredTasks.filter(t => t.status === 'progress').length;
            const completed = filteredTasks.filter(t => t.status === 'done').length;

            // –û–Ω–æ–≤–ª—é—î–º–æ —á–∏—Å–ª–∞ –Ω–∞ –∫–∞—Ä—Ç–∫–∞—Ö
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completedCount').textContent = completed;
        }

        function clearControlFilters() {
            document.getElementById('controlAssigneeFilter').value = '';
            document.getElementById('controlFunctionFilter').value = '';
            document.getElementById('controlPeriodFilter').value = 'all';
            updateControlPanel();
        }

        function renderControlDashboard() {
            updateControlOverview();
            updateControlView();
        }

        function updateControlOverview() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const urgent = tasks.filter(t => new Date(t.deadline) < now && t.status !== 'done').length;
            const warning = tasks.filter(t => {
                const deadline = new Date(t.deadline);
                return deadline >= today && deadline < tomorrow && t.status !== 'done';
            }).length;
            const active = tasks.filter(t => t.status === 'progress').length;
            const completed = tasks.filter(t => t.status === 'done').length;

            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completedCount').textContent = completed;
        }

        function updateControlView() {
            const view = document.getElementById('controlView')?.value || 'workload';
            const container = document.getElementById('controlContent');

            if (view === 'workload') {
                const assignees = [...new Set(tasks.map(t => t.assignee))].filter(Boolean);
                container.innerHTML = `<h3>–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤</h3>` +
                    assignees.map(assignee => {
                        const assigneeTasks = tasks.filter(t => t.assignee === assignee);
                        const active = assigneeTasks.filter(t => t.status !== 'done');
                        const overdue = assigneeTasks.filter(t => new Date(t.deadline) < new Date() && t.status !== 'done');

                        return `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>${assignee}</strong>
                                    <div>
                                        –í—Å—å–æ–≥–æ: ${assigneeTasks.length} | 
                                        –ê–∫—Ç–∏–≤–Ω–∏—Ö: ${active.length}
                                        ${overdue.length > 0 ? ` | <span style="color: #e74c3c;">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ: ${overdue.length}</span>` : ''}
                                    </div>
                                </div>
                            </div>`;
                    }).join('');
            }
        }

        function renderAnalytics() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'done').length;
            const overdue = tasks.filter(t => new Date(t.deadline) < new Date() && t.status !== 'done').length;
            const efficiency = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasksCount').textContent = total;
            document.getElementById('completedTasksCount').textContent = completed;
            document.getElementById('overdueTasksCount').textContent = overdue;
            document.getElementById('efficiencyPercent').textContent = efficiency + '%';

            renderStatusChart();
            renderWorkloadChart();
        }

        function renderStatusChart() {
            const counts = {
                new: tasks.filter(t => t.status === 'new').length,
                progress: tasks.filter(t => t.status === 'progress').length,
                review: tasks.filter(t => t.status === 'review').length,
                done: tasks.filter(t => t.status === 'done').length
            };
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            
            document.getElementById('statusChart').innerHTML = Object.entries(counts).map(([status, count]) => {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                const colors = {new: '#3498db', progress: '#f39c12', review: '#e91e63', done: '#27ae60'};
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: ${colors[status]}; border-radius: 2px;"></div>
                            <span style="font-size: 0.85rem;">${getStatusText(status)}</span>
                        </div>
                        <div style="flex: 1; margin: 0 1rem;">
                            <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: ${colors[status]}; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <span style="font-weight: 600; font-size: 0.8rem; min-width: 40px;">${count} (${percentage}%)</span>
                    </div>`;
            }).join('');
        }

        function renderWorkloadChart() {
            const assignees = [...new Set(tasks.map(t => t.assignee))].filter(Boolean);
            const maxTasks = Math.max(...assignees.map(a => tasks.filter(t => t.assignee === a).length), 1);
            
            document.getElementById('workloadChart').innerHTML = assignees.map(assignee => {
                const assigneeTasks = tasks.filter(t => t.assignee === assignee);
                const active = assigneeTasks.filter(t => t.status !== 'done');
                const percentage = Math.round((assigneeTasks.length / maxTasks) * 100);
                
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="font-weight: 600; font-size: 0.85rem;">${assignee}</span>
                            <span style="font-size: 0.8rem;">${assigneeTasks.length} (${active.length} –∞–∫—Ç–∏–≤–Ω–∏—Ö)</span>
                        </div>
                        <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: #3498db; transition: width 0.3s;"></div>
                        </div>
                    </div>`;
            }).join('');
        }

        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
        function openUserModal(userId = null) {
            if (!hasPermission('manageUsers')) {
                showPermissionError();
                return;
            }
            document.getElementById('userModal').style.display = 'block';
            if (userId) {
                editingUserId = userId;
                fillUserForm(userId);
                document.getElementById('userModalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞';
            } else {
                editingUserId = null;
                clearUserForm();
                document.getElementById('userModalTitle').textContent = '–î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞';
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            editingUserId = null;
        }

        function clearUserForm() {
            ['userName', 'userEmail', 'userPhone', 'userPosition', 'userDepartment', 'userNotes'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('userRole').value = 'employee';
        }

        function fillUserForm(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPhone').value = user.phone || '';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userPosition').value = user.position || '';
                document.getElementById('userDepartment').value = user.department || '';
                document.getElementById('userNotes').value = user.notes || '';
            }
        }

        function saveUser() {
            const data = {
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                phone: document.getElementById('userPhone').value.trim(),
                role: document.getElementById('userRole').value,
                position: document.getElementById('userPosition').value.trim(),
                department: document.getElementById('userDepartment').value.trim(),
                notes: document.getElementById('userNotes').value.trim()
            };

            if (!data.name || !data.email) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —ñ–º\'—è —Ç–∞ email');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ email
            const existingUser = users.find(u => u.email === data.email && (!editingUserId || u.id !== editingUserId));
            if (existingUser) {
                alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ —ñ—Å–Ω—É—î');
                return;
            }

            if (editingUserId) {
                const idx = users.findIndex(u => u.id === editingUserId);
                if (idx !== -1) {
                    const oldName = users[idx].name;
                    users[idx] = {...users[idx], ...data};
                    
                    // –û–Ω–æ–≤–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è —è–∫—â–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è —ñ–º'—è
                    if (oldName !== data.name) {
                        tasks.forEach(task => {
                            if (task.assignee === oldName) task.assignee = data.name;
                            if (task.creator === oldName) task.creator = data.name;
                        });
                        
                        functions.forEach(func => {
                            func.assignees = func.assignees.map(a => a === oldName ? data.name : a);
                        });
                        
                        regularTasks.forEach(rt => {
                            if (rt.assignee === oldName) rt.assignee = data.name;
                        });
                    }
                }
                alert('–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ');
            } else {
                const newUser = {
                    id: Math.max(...users.map(u => u.id || 0), 0) + 1,
                    ...data
                };
                users.push(newUser);
                alert('–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ');
            }

            saveData();
            updateSelects();
            renderUsers();
            closeUserModal();
        }

        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —î –∑–∞–≤–¥–∞–Ω–Ω—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—ñ —Ü—å–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
            const userTasks = tasks.filter(t => t.assignee === user.name || t.creator === user.name);
            if (userTasks.length > 0) {
                if (!confirm(`–£ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${user.name} —î ${userTasks.length} –∑–∞–≤–¥–∞–Ω—å. –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å–µ –æ–¥–Ω–æ?`)) {
                    return;
                }
            }

            if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ ${user.name}?`)) {
                users = users.filter(u => u.id !== userId);
                
                // –í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ñ—É–Ω–∫—Ü—ñ–π
                functions.forEach(func => {
                    func.assignees = func.assignees.filter(a => a !== user.name);
                });

                saveData();
                updateSelects();
                renderUsers();
                renderTasks();
                alert('–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–æ');
            }
        }

        // üîç –ü–û–®–£–ö –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í
        function updateUserFilters() {
            // üÜï –§–Ü–õ–¨–¢–† –î–ï–ü–ê–†–¢–ê–ú–ï–ù–¢–Ü–í –ó –§–£–ù–ö–¶–Ü–ô
            const departmentFilter = document.getElementById('userDepartmentFilter');
            if (departmentFilter) {
                // –ë–µ—Ä–µ–º–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏ –∑ —Ñ—É–Ω–∫—Ü—ñ–π
                const departmentsFromFunctions = [...new Set(functions.map(f => f.department).filter(d => d))];
                // –¢–∞–∫–æ–∂ –±–µ—Ä–µ–º–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏ –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
                const departmentsFromUsers = [...new Set(users.map(u => u.department).filter(d => d))];
                // –û–±'—î–¥–Ω—É—î–º–æ —Ç–∞ –≤–∏–¥–∞–ª—è—î–º–æ –¥—É–±–ª—ñ
                const allDepartments = [...new Set([...departmentsFromFunctions, ...departmentsFromUsers])];
                
                departmentFilter.innerHTML = '<option value="">–í—Å—ñ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏</option>' +
                    allDepartments.map(d => `<option value="${d}">${d}</option>`).join('');
            }

            // –§–Ü–õ–¨–¢–† –§–£–ù–ö–¶–Ü–ô
            const functionFilter = document.getElementById('userFunctionFilter');
            if (functionFilter) {
                functionFilter.innerHTML = '<option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option>';
                functions.forEach(func => {
                    const departmentLabel = func.department ? ` (${func.department})` : '';
                    functionFilter.innerHTML += `<option value="${func.name}">${func.name}${departmentLabel}</option>`;
                });
            }
        }

        function filterUsers() {
            const searchInput = document.getElementById('userSearchInput')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('userRoleFilter')?.value || '';
            const departmentFilter = document.getElementById('userDepartmentFilter')?.value || '';
            const functionFilter = document.getElementById('userFunctionFilter')?.value || '';

            const filteredUsers = users.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchInput) || 
                                    user.email.toLowerCase().includes(searchInput);
                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesDepartment = !departmentFilter || user.department === departmentFilter;
                
                // üÜï –§–Ü–õ–¨–¢–† –ü–û –§–£–ù–ö–¶–Ü–Ø–•
                let matchesFunction = true;
                if (functionFilter) {
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–æ —Ü—ñ—î—ó —Ñ—É–Ω–∫—Ü—ñ—ó
                    const userFunction = functions.find(f => f.name === functionFilter);
                    matchesFunction = userFunction && userFunction.assignees.includes(user.name);
                }

                return matchesSearch && matchesRole && matchesDepartment && matchesFunction;
            });

            renderFilteredUsers(filteredUsers);
            updateUserStats(filteredUsers);
        }

        function renderFilteredUsers(filteredUsers) {
            const container = document.getElementById('usersContainer');
            
            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üîç –ù–µ–º–∞—î —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤</h3>
                        <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É</p>
                        <button onclick="clearUserFilters()" class="btn">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="function-cards">
                    ${filteredUsers.map(user => {
                        const roleText = {owner: '–í–ª–∞—Å–Ω–∏–∫', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}[user.role];
                        const roleColor = {owner: '#e74c3c', manager: '#f39c12', employee: '#3498db'}[user.role];
                        const userTasks = tasks.filter(t => t.assignee === user.name);
                        const activeTasks = userTasks.filter(t => t.status !== 'done');
                        
                        return `
                            <div class="function-card">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <div class="function-title">${user.name}</div>
                                    <span style="background: ${roleColor}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${roleText}</span>
                                </div>
                                
                                <div style="margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.4;">
                                    ${user.position ? `<div><strong>–ü–æ—Å–∞–¥–∞:</strong> ${user.position}</div>` : ''}
                                    ${user.department ? `<div><strong>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</strong> ${user.department}</div>` : ''}
                                    <div><strong>Email:</strong> ${user.email}</div>
                                    ${user.phone ? `<div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${user.phone}</div>` : ''}
                                    <div><strong>–§—É–Ω–∫—Ü—ñ—ó:</strong> ${functions.filter(f => f.assignees.includes(user.name)).map(f => f.name).join(', ') || '–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ'}</div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="font-size: 0.85rem;">
                                        <div>–ó–∞–≤–¥–∞–Ω—å: <strong>${userTasks.length}</strong></div>
                                        <div>–ê–∫—Ç–∏–≤–Ω–∏—Ö: <strong style="color: ${activeTasks.length > 0 ? '#f39c12' : '#27ae60'};">${activeTasks.length}</strong></div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    ${userTasks.length > 0 ? `<button class="btn btn-small" style="background: #f39c12; color: white;" onclick="alert('–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—è: ${userTasks.length} –∑–∞–≤–¥–∞–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${user.name}')" title="–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç–∏ ${userTasks.length} –∑–∞–≤–¥–∞–Ω—å">üîÑ</button>` : ''}
                                    <button class="btn btn-small" onclick="openUserModal(${user.id})">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                                    ${user.role !== 'owner' ? `<button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>` : ''}
                                </div>
                            </div>`;
                    }).join('')}
                </div>`;
        }

        function updateUserStats(filteredUsers) {
            const statsContainer = document.getElementById('userStats');
            if (!statsContainer) return;

            const totalUsers = filteredUsers.length;
            const originalCount = users.length;
            
            const byRole = {
                owner: filteredUsers.filter(u => u.role === 'owner').length,
                manager: filteredUsers.filter(u => u.role === 'manager').length,
                employee: filteredUsers.filter(u => u.role === 'employee').length
            };

            statsContainer.innerHTML = `
                üìä –ü–æ–∫–∞–∑–∞–Ω–æ <strong>${totalUsers}</strong> –∑ <strong>${originalCount}</strong> —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ 
                | üëë –í–ª–∞—Å–Ω–∏–∫—ñ–≤: ${byRole.owner} üë®‚Äçüíº –ú–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤: ${byRole.manager} üë• –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤: ${byRole.employee}
            `;
        }

        function clearUserFilters() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userRoleFilter').value = '';
            document.getElementById('userDepartmentFilter').value = '';
            document.getElementById('userFunctionFilter').value = ''; // üÜï –û–ß–ò–©–ï–ù–ù–Ø –§–Ü–õ–¨–¢–†–£ –§–£–ù–ö–¶–Ü–ô
            renderFilteredUsers(users);
            updateUserStats(users);
        }

        function renderUsers() {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</h3>
                        <p>–î–æ–¥–∞–π—Ç–µ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ–º–∞–Ω–¥–æ—é</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="function-cards">
                    ${users.map(user => {
                        const roleText = {owner: '–í–ª–∞—Å–Ω–∏–∫', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}[user.role];
                        const roleColor = {owner: '#e74c3c', manager: '#f39c12', employee: '#3498db'}[user.role];
                        const userTasks = tasks.filter(t => t.assignee === user.name);
                        const activeTasks = userTasks.filter(t => t.status !== 'done');
                        
                        return `
                            <div class="function-card">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <div class="function-title">${user.name}</div>
                                    <span style="background: ${roleColor}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${roleText}</span>
                                </div>
                                
                                <div style="margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.4;">
                                    ${user.position ? `<div><strong>–ü–æ—Å–∞–¥–∞:</strong> ${user.position}</div>` : ''}
                                    ${user.department ? `<div><strong>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</strong> ${user.department}</div>` : ''}
                                    <div><strong>Email:</strong> ${user.email}</div>
                                    ${user.phone ? `<div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${user.phone}</div>` : ''}
                                    ${user.notes ? `<div style="margin-top: 0.5rem;"><strong>–ü—Ä–∏–º—ñ—Ç–∫–∏:</strong> ${user.notes}</div>` : ''}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="font-size: 0.85rem;">
                                        <div>–ó–∞–≤–¥–∞–Ω—å: <strong>${userTasks.length}</strong></div>
                                        <div>–ê–∫—Ç–∏–≤–Ω–∏—Ö: <strong style="color: ${activeTasks.length > 0 ? '#f39c12' : '#27ae60'};">${activeTasks.length}</strong></div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button class="btn btn-small" onclick="openUserModal(${user.id})">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                                    ${user.role !== 'owner' ? `<button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>` : ''}
                                </div>
                            </div>`;
                    }).join('')}
                </div>`;
        }

        function updateSelects() {
            const taskFunc = document.getElementById('taskFunction');
            const funcFilter = document.getElementById('functionFilter');
            const taskAssignee = document.getElementById('taskAssignee');
            const assigneeFilter = document.getElementById('assigneeFilter');

            [taskFunc, funcFilter].forEach(el => {
                if (el) {
                    const current = el.value;
                    el.innerHTML = (el.id.includes('taskFunction') ? '<option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' : '<option value="">–§—É–Ω–∫—Ü—ñ—ó</option>') +
                        functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
                    el.value = current;
                }
            });

            [taskAssignee, assigneeFilter].forEach(el => {
                if (el) {
                    const current = el.value;
                    el.innerHTML = (el.id.includes('taskAssignee') ? '<option value="">–û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–≤—Ü—è</option>' : '<option value="">–í–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>') +
                        users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
                    el.value = current;
                }
            });
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const now = new Date();
            const isOverdue = date < now;
            const formatted = date.toLocaleString('uk-UA', {
                year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            return isOverdue ? `<span style="color: #e74c3c; font-weight: 600;">${formatted}</span>` : formatted;
        }

        function getStatusText(status) {
            return t(`status.${status}`) || status;
        }

        function getTypeText(type) {
            return t(`type.${type}`) || type;
        }

        function exportToCSV() {
            const data = tasks.map(task => ({
                '–ó–∞–≤–¥–∞–Ω–Ω—è': task.title,
                '–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π': task.assignee,
                '–°—Ç–≤–æ—Ä–∏–≤': task.creator,
                '–î–µ–¥–ª–∞–π–Ω': formatDateTime(task.deadline).replace(/<[^>]*>/g, ''),
                '–°—Ç–∞—Ç—É—Å': getStatusText(task.status),
                '–¢–∏–ø': getTypeText(task.type),
                '–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç': task.priority || 'medium',
                '–§—É–Ω–∫—Ü—ñ—è': task.function || '',
                '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è': task.additionalInfo || '',
                '–Ø–∫ –∑–≤—ñ—Ç—É–≤–∞—Ç–∏—Å—è': task.howToReport || '',
                '–†–µ–∑—É–ª—å—Ç–∞—Ç': task.result || ''
            }));

            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).map(val => `"${val}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `tasks_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // üåç –°–ò–°–¢–ï–ú–ê –ü–ï–†–ï–ö–õ–ê–î–Ü–í
        const translations = {
            'ua': {
                // Header
                'header.title': 'TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä Pro',
                'header.logout': '–í–∏–π—Ç–∏',
                'header.support': '–ü—ñ–¥—Ç—Ä–∏–º–∫–∞',
                
                // Tabs
                'tabs.tasks': '–ó–∞–≤–¥–∞–Ω–Ω—è',
                'tabs.control': '–ö–æ–Ω—Ç—Ä–æ–ª—å', 
                'tabs.regular': '–†–µ–≥—É–ª—è—Ä–Ω—ñ',
                'tabs.functions': '–§—É–Ω–∫—Ü—ñ—ó',
                'tabs.users': '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏',
                'tabs.analytics': '–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞',
                
                // Buttons
                'btn.add_task': '+ –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è',
                'btn.add_function': '+ –î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é',
                'btn.add_user': '+ –î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞',
                'btn.add_regular': '+ –†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è',
                'btn.invite_user': 'üì§ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞',
                'btn.export_csv': 'üìä –ï–∫—Å–ø–æ—Ä—Ç CSV',
                'btn.clear_filters': 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏',
                'btn.save': '–ó–±–µ—Ä–µ–≥—Ç–∏',
                'btn.cancel': '–°–∫–∞—Å—É–≤–∞—Ç–∏',
                'btn.edit': '‚úèÔ∏è',
                'btn.delete': 'üóëÔ∏è',
                'btn.send_code': 'üìß –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥',
                'btn.login': '‚úÖ –£–≤—ñ–π—Ç–∏',
                'btn.back': '‚Üê –ù–∞–∑–∞–¥',
                
                // Forms
                'form.task_title': '–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è:',
                'form.function': '–§—É–Ω–∫—Ü—ñ—è:',
                'form.assignee': '–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π:',
                'form.deadline': '–î–µ–¥–ª–∞–π–Ω:',
                'form.type': '–¢–∏–ø:',
                'form.status': '–°—Ç–∞—Ç—É—Å:',
                'form.priority': '–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:',
                'form.pin': '–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏:',
                'form.additional_info': '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:',
                'form.how_to_report': '–Ø–∫ –∑–≤—ñ—Ç—É–≤–∞—Ç–∏—Å—è:',
                'form.result': '–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–¥–∞–Ω–Ω—è:',
                'form.name': '–Ü–º\'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ:',
                'form.email': 'Email:',
                'form.phone': '–¢–µ–ª–µ—Ñ–æ–Ω:',
                'form.role': '–†–æ–ª—å:',
                'form.position': '–ü–æ—Å–∞–¥–∞:',
                'form.department': '–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:',
                'form.notes': '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:',
                
                // Status
                'status.new': '–ù–æ–≤–µ',
                'status.progress': '–í —Ä–æ–±–æ—Ç—ñ',
                'status.review': '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞', 
                'status.done': '–ì–æ—Ç–æ–≤–æ',
                
                // Types
                'type.single': '–†–∞–∑–æ–≤–µ',
                'type.regular': '–†–µ–≥—É–ª—è—Ä–Ω–µ',
                'type.bottleneck': '–í—É–∑—å–∫–µ –º—ñ—Å—Ü–µ',
                
                // Roles
                'role.owner': '–í–ª–∞—Å–Ω–∏–∫',
                'role.manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
                'role.employee': '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫',
                
                // Auth
                'auth.login': '–í—Ö—ñ–¥ –¥–æ —Å–∏—Å—Ç–µ–º–∏',
                'auth.email': 'Email:',
                'auth.code': '–ö–æ–¥ –∑ email:',
                'auth.welcome': '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏',
                
                // Control Dashboard
                'control.critical': 'üö® –ö—Ä–∏—Ç–∏—á–Ω—ñ',
                'control.warning': '‚ö†Ô∏è –£–≤–∞–≥–∞', 
                'control.active': 'üîÑ –ê–∫—Ç–∏–≤–Ω—ñ',
                'control.completed': '‚úÖ –ì–æ—Ç–æ–≤–æ',
                'control.overdue': '–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ',
                'control.today_tomorrow': '–°—å–æ–≥–æ–¥–Ω—ñ-–∑–∞–≤—Ç—Ä–∞',
                'control.in_progress': '–í —Ä–æ–±–æ—Ç—ñ',
                'control.finished': '–ó–∞–≤–µ—Ä—à–µ–Ω—ñ'
            },
            
            'ru': {
                // Header
                'header.title': 'TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä Pro',
                'header.logout': '–í—ã–π—Ç–∏',
                'header.support': '–ü–æ–¥–¥–µ—Ä–∂–∫–∞',
                
                // Tabs
                'tabs.tasks': '–ó–∞–¥–∞—á–∏',
                'tabs.control': '–ö–æ–Ω—Ç—Ä–æ–ª—å',
                'tabs.regular': '–†–µ–≥—É–ª—è—Ä–Ω—ã–µ', 
                'tabs.functions': '–§—É–Ω–∫—Ü–∏–∏',
                'tabs.users': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
                'tabs.analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                
                // Buttons
                'btn.add_task': '+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É',
                'btn.add_function': '+ –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é',
                'btn.add_user': '+ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
                'btn.add_regular': '+ –†–µ–≥—É–ª—è—Ä–Ω–∞—è –∑–∞–¥–∞—á–∞',
                'btn.invite_user': 'üì§ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
                'btn.export_csv': 'üìä –≠–∫—Å–ø–æ—Ä—Ç CSV',
                'btn.clear_filters': 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å',
                'btn.save': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                'btn.cancel': '–û—Ç–º–µ–Ω–∏—Ç—å',
                'btn.edit': '‚úèÔ∏è',
                'btn.delete': 'üóëÔ∏è',
                'btn.send_code': 'üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥',
                'btn.login': '‚úÖ –í–æ–π—Ç–∏',
                'btn.back': '‚Üê –ù–∞–∑–∞–¥',
                
                // Forms
                'form.task_title': '–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:',
                'form.function': '–§—É–Ω–∫—Ü–∏—è:',
                'form.assignee': '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:',
                'form.deadline': '–î–µ–¥–ª–∞–π–Ω:',
                'form.type': '–¢–∏–ø:',
                'form.status': '–°—Ç–∞—Ç—É—Å:',
                'form.priority': '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:',
                'form.pin': '–ó–∞–∫—Ä–µ–ø–∏—Ç—å:',
                'form.additional_info': '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:',
                'form.how_to_report': '–ö–∞–∫ –æ—Ç—á–∏—Ç–∞—Ç—å—Å—è:',
                'form.result': '–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏:',
                'form.name': '–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è:',
                'form.email': 'Email:',
                'form.phone': '–¢–µ–ª–µ—Ñ–æ–Ω:',
                'form.role': '–†–æ–ª—å:',
                'form.position': '–î–æ–ª–∂–Ω–æ—Å—Ç—å:',
                'form.department': '–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:',
                'form.notes': '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:',
                
                // Status
                'status.new': '–ù–æ–≤–∞—è',
                'status.progress': '–í —Ä–∞–±–æ—Ç–µ',
                'status.review': '–ü—Ä–æ–≤–µ—Ä–∫–∞',
                'status.done': '–ì–æ—Ç–æ–≤–æ',
                
                // Types
                'type.single': '–†–∞–∑–æ–≤–∞—è',
                'type.regular': '–†–µ–≥—É–ª—è—Ä–Ω–∞—è',
                'type.bottleneck': '–£–∑–∫–æ–µ –º–µ—Å—Ç–æ',
                
                // Roles
                'role.owner': '–í–ª–∞–¥–µ–ª–µ—Ü',
                'role.manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
                'role.employee': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
                
                // Auth
                'auth.login': '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É',
                'auth.email': 'Email:',
                'auth.code': '–ö–æ–¥ –∏–∑ email:',
                'auth.welcome': '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏',
                
                // Control Dashboard
                'control.critical': 'üö® –ö—Ä–∏—Ç–∏—á–Ω—ã–µ',
                'control.warning': '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ',
                'control.active': 'üîÑ –ê–∫—Ç–∏–≤–Ω—ã–µ',
                'control.completed': '‚úÖ –ì–æ—Ç–æ–≤–æ',
                'control.overdue': '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ',
                'control.today_tomorrow': '–°–µ–≥–æ–¥–Ω—è-–∑–∞–≤—Ç—Ä–∞',
                'control.in_progress': '–í —Ä–∞–±–æ—Ç–µ',
                'control.finished': '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ'
            },
            
            'bg': {
                // Header
                'header.title': 'TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–∏–¥–∂—ä—Ä Pro',
                'header.logout': '–ò–∑—Ö–æ–¥',
                'header.support': '–ü–æ–¥–¥—Ä—ä–∂–∫–∞',
                
                // Tabs
                'tabs.tasks': '–ó–∞–¥–∞—á–∏',
                'tabs.control': '–ö–æ–Ω—Ç—Ä–æ–ª',
                'tabs.regular': '–†–µ–¥–æ–≤–Ω–∏',
                'tabs.functions': '–§—É–Ω–∫—Ü–∏–∏',
                'tabs.users': '–°–ª—É–∂–∏—Ç–µ–ª–∏',
                'tabs.analytics': '–ê–Ω–∞–ª–∏–∑–∏',
                
                // Buttons
                'btn.add_task': '+ –î–æ–±–∞–≤–∏ –∑–∞–¥–∞—á–∞',
                'btn.add_function': '+ –î–æ–±–∞–≤–∏ —Ñ—É–Ω–∫—Ü–∏—è',
                'btn.add_user': '+ –î–æ–±–∞–≤–∏ —Å–ª—É–∂–∏—Ç–µ–ª',
                'btn.add_regular': '+ –†–µ–¥–æ–≤–Ω–∞ –∑–∞–¥–∞—á–∞',
                'btn.invite_user': 'üì§ –ü–æ–∫–∞–Ω–∏ —Å–ª—É–∂–∏—Ç–µ–ª',
                'btn.export_csv': 'üìä –ï–∫—Å–ø–æ—Ä—Ç CSV',
                'btn.clear_filters': 'üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏',
                'btn.save': '–ó–∞–ø–∞–∑–∏',
                'btn.cancel': '–û—Ç–∫–∞–∑',
                'btn.edit': '‚úèÔ∏è',
                'btn.delete': 'üóëÔ∏è',
                'btn.send_code': 'üìß –ò–∑–ø—Ä–∞—Ç–∏ –∫–æ–¥',
                'btn.login': '‚úÖ –í–ª–µ–∑',
                'btn.back': '‚Üê –ù–∞–∑–∞–¥',
                
                // Forms
                'form.task_title': '–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:',
                'form.function': '–§—É–Ω–∫—Ü–∏—è:',
                'form.assignee': '–û—Ç–≥–æ–≤–æ—Ä–µ–Ω:',
                'form.deadline': '–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫:',
                'form.type': '–¢–∏–ø:',
                'form.status': '–°—Ç–∞—Ç—É—Å:',
                'form.priority': '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:',
                'form.pin': '–ó–∞–∫–∞—á–∏:',
                'form.additional_info': '–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:',
                'form.how_to_report': '–ö–∞–∫ –¥–∞ –¥–æ–∫–ª–∞–¥–≤–∞:',
                'form.result': '–†–µ–∑—É–ª—Ç–∞—Ç –æ—Ç –∑–∞–¥–∞—á–∞—Ç–∞:',
                'form.name': '–ò–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è:',
                'form.email': 'Email:',
                'form.phone': '–¢–µ–ª–µ—Ñ–æ–Ω:',
                'form.role': '–†–æ–ª—è:',
                'form.position': '–î–ª—ä–∂–Ω–æ—Å—Ç:',
                'form.department': '–û—Ç–¥–µ–ª:',
                'form.notes': '–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:',
                
                // Status
                'status.new': '–ù–æ–≤–∞',
                'status.progress': '–í —Ä–∞–±–æ—Ç–∞',
                'status.review': '–ü—Ä–æ–≤–µ—Ä–∫–∞',
                'status.done': '–ì–æ—Ç–æ–≤–æ',
                
                // Types
                'type.single': '–ï–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞',
                'type.regular': '–†–µ–¥–æ–≤–Ω–∞',
                'type.bottleneck': '–¢—è—Å–Ω–æ –º—è—Å—Ç–æ',
                
                // Roles
                'role.owner': '–°–æ–±—Å—Ç–≤–µ–Ω–∏–∫',
                'role.manager': '–ú–µ–Ω–∏–¥–∂—ä—Ä',
                'role.employee': '–°–ª—É–∂–∏—Ç–µ–ª',
                
                // Auth
                'auth.login': '–í–ª–∏–∑–∞–Ω–µ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞',
                'auth.email': 'Email:',
                'auth.code': '–ö–æ–¥ –æ—Ç email:',
                'auth.welcome': '–°–∏—Å—Ç–µ–º–∞ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∑–∞–¥–∞—á–∏',
                
                // Control Dashboard
                'control.critical': 'üö® –ö—Ä–∏—Ç–∏—á–Ω–∏',
                'control.warning': '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ',
                'control.active': 'üîÑ –ê–∫—Ç–∏–≤–Ω–∏',
                'control.completed': '‚úÖ –ì–æ—Ç–æ–≤–æ',
                'control.overdue': '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∏',
                'control.today_tomorrow': '–î–Ω–µ—Å-—É—Ç—Ä–µ',
                'control.in_progress': '–í —Ä–∞–±–æ—Ç–∞',
                'control.finished': '–ó–∞–≤—ä—Ä—à–µ–Ω–∏'
            },
            
            'en': {
                // Header
                'header.title': 'TALKO System - Task Manager Pro',
                'header.logout': 'Logout',
                'header.support': 'Support',
                
                // Tabs
                'tabs.tasks': 'Tasks',
                'tabs.control': 'Control',
                'tabs.regular': 'Regular',
                'tabs.functions': 'Functions',
                'tabs.users': 'Employees',
                'tabs.analytics': 'Analytics',
                
                // Buttons
                'btn.add_task': '+ Add Task',
                'btn.add_function': '+ Add Function',
                'btn.add_user': '+ Add Employee',
                'btn.add_regular': '+ Regular Task',
                'btn.invite_user': 'üì§ Invite Employee',
                'btn.export_csv': 'üìä Export CSV',
                'btn.clear_filters': 'üóëÔ∏è Clear',
                'btn.save': 'Save',
                'btn.cancel': 'Cancel',
                'btn.edit': '‚úèÔ∏è',
                'btn.delete': 'üóëÔ∏è',
                'btn.send_code': 'üìß Send Code',
                'btn.login': '‚úÖ Login',
                'btn.back': '‚Üê Back',
                
                // Forms
                'form.task_title': 'Task Title:',
                'form.function': 'Function:',
                'form.assignee': 'Assignee:',
                'form.deadline': 'Deadline:',
                'form.type': 'Type:',
                'form.status': 'Status:',
                'form.priority': 'Priority:',
                'form.pin': 'Pin:',
                'form.additional_info': 'Additional Information:',
                'form.how_to_report': 'How to Report:',
                'form.result': 'Task Result:',
                'form.name': 'Full Name:',
                'form.email': 'Email:',
                'form.phone': 'Phone:',
                'form.role': 'Role:',
                'form.position': 'Position:',
                'form.department': 'Department:',
                'form.notes': 'Additional Information:',
                
                // Status
                'status.new': 'New',
                'status.progress': 'In Progress',
                'status.review': 'Review',
                'status.done': 'Done',
                
                // Types
                'type.single': 'Single',
                'type.regular': 'Regular',
                'type.bottleneck': 'Bottleneck',
                
                // Roles
                'role.owner': 'Owner',
                'role.manager': 'Manager',
                'role.employee': 'Employee',
                
                // Auth
                'auth.login': 'System Login',
                'auth.email': 'Email:',
                'auth.code': 'Code from email:',
                'auth.welcome': 'Task Management System',
                
                // Control Dashboard
                'control.critical': 'üö® Critical',
                'control.warning': '‚ö†Ô∏è Warning',
                'control.active': 'üîÑ Active',
                'control.completed': '‚úÖ Completed',
                'control.overdue': 'Overdue',
                'control.today_tomorrow': 'Today-Tomorrow',
                'control.in_progress': 'In Progress',
                'control.finished': 'Finished'
            }
        };

        let currentLanguage = localStorage.getItem('talko_language') || 'ua';

        function t(key) {
            return translations[currentLanguage]?.[key] || key;
        }

        function updatePageContent() {
            console.log('Updating page content for language:', currentLanguage);
            
            // Update header
            const logoEl = document.querySelector('.logo');
            if (logoEl) logoEl.textContent = t('header.title');
            document.title = t('header.title');
            
            // Update logout button
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) logoutBtn.innerHTML = `üö™ ${t('header.logout')}`;
            
            // Update support button
            const supportBtn = document.querySelector('a[href="https://alextalko.com"]');
            if (supportBtn) supportBtn.textContent = `üõü ${t('header.support')}`;
            
            // Update tabs
            const tabButtons = document.querySelectorAll('.tab-btn');
            if (tabButtons.length >= 6) {
                tabButtons[0].textContent = t('tabs.tasks');
                tabButtons[1].textContent = t('tabs.control');
                tabButtons[2].textContent = t('tabs.regular');
                tabButtons[3].textContent = t('tabs.functions');
                tabButtons[4].textContent = t('tabs.users');
                tabButtons[5].textContent = t('tabs.analytics');
            }
            
            // Update filter selects
            updateFilterSelects();
            
            // Update ALL buttons systematically
            document.querySelectorAll('button').forEach(btn => {
                const text = btn.textContent.trim();
                
                // Main action buttons
                if (text.includes('–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è') || text.includes('Add Task') || text.includes('–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É') || text.includes('–î–æ–±–∞–≤–∏ –∑–∞–¥–∞—á–∞')) {
                    btn.textContent = t('btn.add_task');
                }
                if (text.includes('–ï–∫—Å–ø–æ—Ä—Ç CSV') || text.includes('Export CSV') || text.includes('–≠–∫—Å–ø–æ—Ä—Ç CSV')) {
                    btn.textContent = t('btn.export_csv');
                }
                if (text.includes('–û—á–∏—Å—Ç–∏—Ç–∏') || text.includes('Clear') || text.includes('–û—á–∏—Å—Ç–∏—Ç—å') || text.includes('–ò–∑—á–∏—Å—Ç–∏')) {
                    btn.textContent = t('btn.clear_filters');
                }
                if (text.includes('–î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é') || text.includes('Add Function') || text.includes('–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é') || text.includes('–î–æ–±–∞–≤–∏ —Ñ—É–Ω–∫—Ü–∏—è')) {
                    btn.textContent = t('btn.add_function');
                }
                if (text.includes('—Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞') || text.includes('Employee') || text.includes('—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞') || text.includes('—Å–ª—É–∂–∏—Ç–µ–ª')) {
                    btn.textContent = t('btn.add_user');
                }
                if (text.includes('–ó–∞–ø—Ä–æ—Å–∏—Ç–∏') || text.includes('Invite') || text.includes('–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å') || text.includes('–ü–æ–∫–∞–Ω–∏')) {
                    btn.innerHTML = `üì§ ${t('btn.invite_user')}`;
                }
                if (text.includes('–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è') || text.includes('Regular Task') || text.includes('–†–µ–≥—É–ª—è—Ä–Ω–∞—è –∑–∞–¥–∞—á–∞') || text.includes('–†–µ–¥–æ–≤–Ω–∞ –∑–∞–¥–∞—á–∞')) {
                    btn.textContent = t('btn.add_regular');
                }
                
                // Modal buttons
                if (text === '–ó–±–µ—Ä–µ–≥—Ç–∏' || text === 'Save' || text === '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' || text === '–ó–∞–ø–∞–∑–∏') {
                    btn.textContent = t('btn.save');
                }
                if (text === '–°–∫–∞—Å—É–≤–∞—Ç–∏' || text === 'Cancel' || text === '–û—Ç–º–µ–Ω–∏—Ç—å' || text === '–û—Ç–∫–∞–∑') {
                    btn.textContent = t('btn.cancel');
                }
                if (text.includes('–ù–∞–∑–∞–¥') || text.includes('Back') || text.includes('–ù–∞–∑–∞–¥')) {
                    btn.textContent = `‚Üê ${t('btn.back')}`;
                }
            });
            
            // Force re-render current tab
            if (window.activeTab || activeTab) {
                const currentTab = window.activeTab || activeTab;
                console.log('Re-rendering active tab:', currentTab);
                switch(currentTab) {
                    case 'tasks': renderTasks(); break;
                    case 'control': renderControlDashboard(); break;
                    case 'regular': renderRegularTasks(); break;
                    case 'functions': renderFunctions(); break;
                    case 'users': renderUsers(); break;
                    case 'analytics': renderAnalytics(); break;
                }
            }
            
            console.log('Page content updated successfully');
        }
        
        function updateFilterSelects() {
            // –ü–µ—Ä–µ–∫–ª–∞–¥–∏ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
            const filterTexts = {
                'ua': {
                    'all_tasks': '–í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è',
                    'pinned': '–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω—ñ',
                    'unpinned': '–ù–µ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω—ñ',
                    'all_dates': '–í—Å—ñ –¥–∞—Ç–∏',
                    'today': '–°—å–æ–≥–æ–¥–Ω—ñ',
                    'week': '–¢–∏–∂–¥–µ–Ω—å',
                    'month': '–ú—ñ—Å—è—Ü—å',
                    'overdue': '–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ',
                    'custom': '–ü–µ—Ä—ñ–æ–¥',
                    'statuses': '–°—Ç–∞—Ç—É—Å–∏',
                    'functions': '–§—É–Ω–∫—Ü—ñ—ó',
                    'assignees': '–í–∏–∫–æ–Ω–∞–≤—Ü—ñ'
                },
                'ru': {
                    'all_tasks': '–í—Å–µ –∑–∞–¥–∞—á–∏',
                    'pinned': '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ',
                    'unpinned': '–ù–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ',
                    'all_dates': '–í—Å–µ –¥–∞—Ç—ã',
                    'today': '–°–µ–≥–æ–¥–Ω—è',
                    'week': '–ù–µ–¥–µ–ª—è',
                    'month': '–ú–µ—Å—è—Ü',
                    'overdue': '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ',
                    'custom': '–ü–µ—Ä–∏–æ–¥',
                    'statuses': '–°—Ç–∞—Ç—É—Å—ã',
                    'functions': '–§—É–Ω–∫—Ü–∏–∏',
                    'assignees': '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏'
                },
                'bg': {
                    'all_tasks': '–í—Å–∏—á–∫–∏ –∑–∞–¥–∞—á–∏',
                    'pinned': '–ó–∞–∫–∞—á–µ–Ω–∏',
                    'unpinned': '–ù–µ –∑–∞–∫–∞—á–µ–Ω–∏',
                    'all_dates': '–í—Å–∏—á–∫–∏ –¥–∞—Ç–∏',
                    'today': '–î–Ω–µ—Å',
                    'week': '–°–µ–¥–º–∏—Ü–∞',
                    'month': '–ú–µ—Å–µ—Ü',
                    'overdue': '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∏',
                    'custom': '–ü–µ—Ä–∏–æ–¥',
                    'statuses': '–°—Ç–∞—Ç—É—Å–∏',
                    'functions': '–§—É–Ω–∫—Ü–∏–∏',
                    'assignees': '–ò–∑–ø—ä–ª–Ω–∏—Ç–µ–ª–∏'
                },
                'en': {
                    'all_tasks': 'All tasks',
                    'pinned': 'Pinned',
                    'unpinned': 'Unpinned',
                    'all_dates': 'All dates',
                    'today': 'Today',
                    'week': 'Week',
                    'month': 'Month',
                    'overdue': 'Overdue',
                    'custom': 'Period',
                    'statuses': 'Statuses',
                    'functions': 'Functions',
                    'assignees': 'Assignees'
                }
            };
            
            const texts = filterTexts[currentLanguage] || filterTexts['ua'];
            
            // Update filter selects
            const pinnedFilter = document.getElementById('pinnedFilter');
            if (pinnedFilter) {
                const currentValue = pinnedFilter.value;
                pinnedFilter.innerHTML = `
                    <option value="">${texts.all_tasks}</option>
                    <option value="pinned">${texts.pinned}</option>
                    <option value="unpinned">${texts.unpinned}</option>
                `;
                pinnedFilter.value = currentValue;
            }
            
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                const currentValue = dateFilter.value;
                dateFilter.innerHTML = `
                    <option value="">${texts.all_dates}</option>
                    <option value="today">${texts.today}</option>
                    <option value="week">${texts.week}</option>
                    <option value="month">${texts.month}</option>
                    <option value="overdue">${texts.overdue}</option>
                    <option value="custom">${texts.custom}</option>
                `;
                dateFilter.value = currentValue;
            }
            
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                const currentValue = statusFilter.value;
                statusFilter.innerHTML = `
                    <option value="">${texts.statuses}</option>
                    <option value="new">${t('status.new')}</option>
                    <option value="progress">${t('status.progress')}</option>
                    <option value="review">${t('status.review')}</option>
                    <option value="done">${t('status.done')}</option>
                `;
                statusFilter.value = currentValue;
            }
            
            const functionFilter = document.getElementById('functionFilter');
            if (functionFilter) {
                const currentValue = functionFilter.value;
                const functionOptions = functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
                functionFilter.innerHTML = `<option value="">${texts.functions}</option>${functionOptions}`;
                functionFilter.value = currentValue;
            }
            
            const assigneeFilter = document.getElementById('assigneeFilter');
            if (assigneeFilter) {
                const currentValue = assigneeFilter.value;
                const assigneeOptions = users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
                assigneeFilter.innerHTML = `<option value="">${texts.assignees}</option>${assigneeOptions}`;
                assigneeFilter.value = currentValue;
            }
        }
        
        function updateTaskHeaders() {
            const translations_headers = {
                'ua': ['–ó–∞–≤–¥–∞–Ω–Ω—è', '–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å', '–°—Ç–≤–æ—Ä–∏–≤', '–î–µ–¥–ª–∞–π–Ω', '–°—Ç–∞—Ç—É—Å', '–¢–∏–ø', '–î—ñ—ó'],
                'ru': ['–ó–∞–¥–∞—á–∏', '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–°–æ–∑–¥–∞–ª', '–î–µ–¥–ª–∞–π–Ω', '–°—Ç–∞—Ç—É—Å', '–¢–∏–ø', '–î–µ–π—Å—Ç–≤–∏—è'],
                'bg': ['–ó–∞–¥–∞—á–∏', '–ò–∑–ø—ä–ª–Ω–∏—Ç–µ–ª', '–°—ä–∑–¥–∞–ª', '–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫', '–°—Ç–∞—Ç—É—Å', '–¢–∏–ø', '–î–µ–π—Å—Ç–≤–∏—è'],
                'en': ['Tasks', 'Assignee', 'Created by', 'Deadline', 'Status', 'Type', 'Actions']
            };
            
            return translations_headers[currentLanguage] || translations_headers['ua'];
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('talko_language', lang);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –∫–Ω–æ–ø–∫—É –º–æ–≤–∏
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="setLanguage('${lang}')"]`).classList.add('active');
            
            // –ì–û–õ–û–í–ù–ï: –æ–Ω–æ–≤–ª—é—î–º–æ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            updatePageContent();
            
            console.log('Language switched to:', lang);
        }

        window.onclick = function(event) {
            ['taskModal', 'functionModal', 'regularTaskModal', 'userModal', 'inviteModal', 'inviteLinkModal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    if (modalId === 'taskModal') editingTaskId = null;
                    if (modalId === 'userModal') editingUserId = null;
                }
            });
        }
    </script>

        <!-- üõü –§–£–¢–ï–† –ó –ü–Ü–î–¢–†–ò–ú–ö–û–Æ -->
        <footer style="text-align: center; padding: 2rem; background: #f8f9fa; border-top: 1px solid #ecf0f1; margin-top: 2rem;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <p style="color: #7f8c8d; margin-bottom: 1rem;">
                    Powered by <strong style="color: #3498db;">TALKO System</strong> - Professional Business Process Automation
                </p>
                <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                    <a href="https://alextalko.com" target="_blank" style="color: #3498db; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;" onmouseover="this.style.color='#2980b9'" onmouseout="this.style.color='#3498db'">
                        –ü—ñ–¥—Ç—Ä–∏–º–∫–∞
                    </a>
                    <a href="https://alextalko.com" target="_blank" style="color: #3498db; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;" onmouseover="this.style.color='#2980b9'" onmouseout="this.style.color='#3498db'">
                        üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
                    </a>
                    <a href="https://alextalko.com" target="_blank" style="color: #3498db; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;" onmouseover="this.style.color='#2980b9'" onmouseout="this.style.color='#3498db'">
                        üí° –ó–∞–ø–∏—Ç —Ñ—É–Ω–∫—Ü—ñ—ó
                    </a>
                </div>
                <p style="color: #95a5a6; font-size: 0.8rem; margin-top: 1rem;">
                    ¬© 2024 TALKO System. –í—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω—ñ.
                </p>
            </div>
        </footer>
</body>
</html>
</html>